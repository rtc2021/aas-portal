# AAS Portal - Netlify Configuration
# Includes: Copilot Function + Snippet Injection for shared resources

[build]
  base = "portal"
  command = "cd ../netlify/functions && npm install && cd ../../portal && echo 'Build complete'"
  publish = "."
  functions = "../netlify/functions"
  ignore = "exit 1"

[functions]
  node_bundler = "esbuild"

[functions."copilot"]
  timeout = 30

# ============================================================================
# ASSET REDIRECTS
# ============================================================================

[[redirects]]
  from = "/auth.js"
  to = "/public/auth.js"
  status = 200

[[redirects]]
  from = "/theme.js"
  to = "/public/theme.js"
  status = 200

[[redirects]]
  from = "/copilot.js"
  to = "/public/copilot.js"
  status = 200

[[redirects]]
  from = "/nav.css"
  to = "/public/nav.css"
  status = 200

[[redirects]]
  from = "/favicon.svg"
  to = "/public/favicon.svg"
  status = 200

[[redirects]]
  from = "/favicon-dark.svg"
  to = "/public/favicon-dark.svg"
  status = 200

[[redirects]]
  from = "/favicon-light.svg"
  to = "/public/favicon-light.svg"
  status = 200

[[redirects]]
  from = "/favicon.ico"
  to = "/public/favicon.ico"
  status = 200

# ============================================================================
# API REDIRECTS
# ============================================================================

[[redirects]]
  from = "/api/copilot"
  to = "/.netlify/functions/copilot"
  status = 200

[[redirects]]
  from = "/api/copilot/*"
  to = "/.netlify/functions/copilot"
  status = 200

[[redirects]]
  from = "/api/qb/*"
  to = "/.netlify/functions/qb"
  status = 200

[[redirects]]
  from = "/api/qb"
  to = "/.netlify/functions/qb"
  status = 200

[[redirects]]
  from = "/api/pipeline/*"
  to = "/.netlify/functions/pipeline"
  status = 200

[[redirects]]
  from = "/api/pipeline"
  to = "/.netlify/functions/pipeline"
  status = 200

# ============================================================================
# TECH ROUTES
# ============================================================================

[[redirects]]
  from = "/tech/command"
  to = "/tech/command/index.html"
  status = 200

[[redirects]]
  from = "/tech/parts"
  to = "/tech/parts/index.html"
  status = 200

[[redirects]]
  from = "/tech/manuals"
  to = "/tech/manuals/index.html"
  status = 200

[[redirects]]
  from = "/tech/doors"
  to = "/tech/doors/index.html"
  status = 200

[[redirects]]
  from = "/tech/summary"
  to = "/tech/summary/index.html"
  status = 200

[[redirects]]
  from = "/tech/pricing"
  to = "/tech/pricing/index.html"
  status = 200

# ============================================================================
# CUSTOMER ROUTES
# ============================================================================

[[redirects]]
  from = "/customer/command"
  to = "/customer/command/index.html"
  status = 200

[[redirects]]
  from = "/customer"
  to = "/customer/command"
  status = 302

# ============================================================================
# DOOR & SERVICE ROUTES
# ============================================================================

[[redirects]]
  from = "/door"
  to = "/door/index.html"
  status = 200

[[redirects]]
  from = "/service"
  to = "/service/index.html"
  status = 200

# ============================================================================
# PIPELINE ROUTES (admin only)
# ============================================================================

[[redirects]]
  from = "/pipeline"
  to = "/pipeline/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/customers"
  to = "/pipeline/customers/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/parts"
  to = "/pipeline/parts/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/preview"
  to = "/pipeline/preview/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/log"
  to = "/pipeline/log/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/rates"
  to = "/pipeline/rates/index.html"
  status = 200

[[redirects]]
  from = "/pipeline/estimates"
  to = "/pipeline/estimates/index.html"
  status = 200

# ============================================================================
# CORS HEADERS FOR API
# ============================================================================
[[headers]]
  for = "/api/*"
  [headers.values]
    Access-Control-Allow-Origin = "https://aas-portal.netlify.app"
    Access-Control-Allow-Methods = "GET, POST, PATCH, PUT, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"

# ============================================================================
# POST-PROCESSING
# ============================================================================

[build.processing]
  skip_processing = false

[build.processing.html]
  pretty_urls = false

# ============================================================================
# SNIPPET INJECTION (Configure in Netlify UI)
# Site settings > Build & deploy > Post processing > Snippet injection
#
# 1. "AAS Global Styles" — before </head>
#    <link rel="stylesheet" href="/src/styles/tokens.css">
#    <link rel="stylesheet" href="/nav.css">
#
# 2. "Favicon and Theme Color" — before </head>
#    <link rel="icon" type="image/svg+xml" href="/favicon-dark.svg" media="(prefers-color-scheme: dark)">
#    <link rel="icon" type="image/svg+xml" href="/favicon-light.svg" media="(prefers-color-scheme: light)">
#    <link rel="icon" href="/favicon.ico">
#    <meta name="theme-color" content="#0b1220">
#
# 3. "AAS Auth Loader" — before </body>
#    <script src="/auth.js" defer></script>
#
# 4. "AAS Theme & Copilot" — before </body>
#    <script src="/theme.js" defer></script>
#    <script src="/copilot.js" defer></script>
# ============================================================================
