<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Command Center • AAS Portal</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #050508;
      --bg-glass: rgba(15, 15, 25, 0.85);
      --bg-card: rgba(25, 25, 40, 0.7);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-glow: rgba(0, 212, 255, 0.4);
      --text-primary: #f5f5fa;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent-cyan: #00d4ff;
      --accent-green: #22c55e;
      --accent-amber: #f59e0b;
      --accent-red: #ef4444;
      --glow-cyan: 0 0 40px rgba(0, 212, 255, 0.25);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-effects {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
    }
    .bg-effects::before {
      content: '';
      position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: 
        radial-gradient(ellipse at 30% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
      animation: bgPulse 15s ease-in-out infinite;
    }
    @keyframes bgPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

    .auth-overlay { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-overlay.hidden { display: none; }
    .auth-card { text-align: center; padding: 48px; background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); border-radius: 24px; max-width: 420px; }
    .auth-card img { height: 48px; margin-bottom: 24px; filter: drop-shadow(0 0 20px rgba(0,212,255,0.5)); }
    .auth-title { font-size: 24px; font-weight: 700; margin: 0 0 8px; display: none; }
    .auth-subtitle { color: var(--text-secondary); margin: 0 0 28px; font-size: 15px; display: none; }
    .auth-btn { display: none; background: linear-gradient(135deg, var(--accent-cyan), #0099cc); color: #0a0a0f; border: none; padding: 16px 40px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .auth-spinner { width: 48px; height: 48px; border: 3px solid var(--border-subtle); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .page-content { display: none; position: relative; z-index: 1; min-height: 100vh; padding: 20px; max-width: 1400px; margin: 0 auto; }

    .cc-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
    .cc-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, var(--accent-cyan) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .cc-subtitle { color: var(--text-muted); margin-top: 6px; font-size: 0.9rem; }
    .cc-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .cc-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 16px;
      background: var(--bg-glass); backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle); border-radius: 10px;
      color: var(--text-primary); font-size: 0.85rem; font-weight: 600;
      text-decoration: none; cursor: pointer; transition: all 0.2s;
    }
    .cc-btn:hover { border-color: var(--border-glow); box-shadow: var(--glow-cyan); transform: translateY(-1px); }
    .cc-btn--primary { background: linear-gradient(135deg, var(--accent-cyan), #0099cc); color: #050508; border: none; }
    .cc-btn--green { background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); color: var(--accent-green); }
    .cc-btn svg { width: 16px; height: 16px; }

    .cc-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .cc-stat { background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 20px; transition: all 0.3s; }
    .cc-stat:hover { border-color: var(--border-glow); box-shadow: var(--glow-cyan); }
    .cc-stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); }
    .cc-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 2rem; font-weight: 700; color: var(--accent-cyan); margin: 8px 0; }
    .cc-stat-hint { font-size: 0.75rem; color: var(--text-muted); }
    .cc-stat-value.warn { color: var(--accent-amber); }
    .cc-stat-value.fail { color: var(--accent-red); }
    .cc-stat-value.good { color: var(--accent-green); }

    .cc-filters {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 24px; padding: 16px;
      background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); border-radius: 16px;
    }
    .cc-input, .cc-select {
      height: 42px; padding: 10px 14px;
      background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px;
      color: var(--text-primary); font-size: 0.9rem;
    }
    .cc-input:focus, .cc-select:focus { outline: none; border-color: var(--accent-cyan); }
    .cc-input::placeholder { color: var(--text-muted); }
    .cc-input.search { flex: 1; min-width: 200px; }
    .cc-label { font-size: 0.75rem; color: var(--text-muted); margin-right: 4px; }
    .cc-dates { display: flex; align-items: center; gap: 8px; }

    .cc-card {
      background: var(--bg-glass); backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle); border-radius: 20px;
      padding: 24px; margin-bottom: 20px; transition: all 0.3s;
    }
    .cc-card:hover { border-color: var(--border-glow); }
    .cc-card-head { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .cc-card-title { font-size: 1.1rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
    .cc-card-title svg { width: 20px; height: 20px; color: var(--accent-cyan); }
    .cc-card-meta { color: var(--text-muted); font-size: 0.85rem; margin-top: 4px; }

    .cc-tablewrap { overflow-x: auto; border-radius: 12px; max-height: 400px; }
    .cc-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .cc-table thead th {
      position: sticky; top: 0; background: rgba(10, 10, 20, 0.98);
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em;
      font-size: 0.7rem; font-weight: 600; padding: 14px 12px; text-align: left;
      border-bottom: 1px solid var(--border-subtle);
    }
    .cc-table td { padding: 12px; border-bottom: 1px solid var(--border-subtle); vertical-align: top; color: var(--text-secondary); }
    .cc-table tbody tr:hover td { background: rgba(0, 212, 255, 0.03); }
    .cc-table a { color: var(--accent-cyan); text-decoration: none; font-family: 'JetBrains Mono', monospace; font-weight: 500; }
    .cc-table a:hover { text-decoration: underline; }

    .status-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-badge.pass { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
    .status-badge.fail { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
    .status-badge.open { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
    .status-badge.complete { background: rgba(0, 212, 255, 0.15); color: var(--accent-cyan); }

    .cc-meta { margin-top: 16px; color: var(--text-muted); font-size: 0.8rem; }

    .floating-user {
      position: fixed; bottom: 20px; right: 20px;
      display: flex; align-items: center; gap: 12px; padding: 10px 16px;
      background: var(--bg-glass); backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle); border-radius: 50px; z-index: 100;
    }
    .floating-user-info { text-align: right; }
    .floating-user-name { font-size: 0.85rem; font-weight: 600; }
    .floating-user-role { font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 0.05em; }
    .floating-user button { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 6px; display: flex; border-radius: 50%; transition: all 0.2s; }
    .floating-user button:hover { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }
    .floating-user svg { width: 18px; height: 18px; }

    .download-group { display: flex; gap: 8px; flex-wrap: wrap; }

    @media (max-width: 900px) {
      .cc-stats { grid-template-columns: repeat(2, 1fr); }
      .cc-filters { flex-direction: column; align-items: stretch; }
      .cc-header { flex-direction: column; }
    }
    @media (max-width: 600px) {
      .cc-stats { grid-template-columns: 1fr; }
      .page-content { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="bg-effects"></div>

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <img src="https://images.squarespace-cdn.com/content/53292562e4b06710691770b4/c75debc4-7194-4008-875d-856c6fa3b205/dis+lis+logo.webp?content-type=image%2Fwebp" alt="AAS">
      <div class="auth-spinner"></div>
      <p id="authLoadingText" style="color: var(--text-muted);">Loading...</p>
      <h1 class="auth-title">Sign In Required</h1>
      <p class="auth-subtitle">Please sign in to access the command center</p>
      <button id="authLoginBtn" class="auth-btn">Sign In</button>
    </div>
  </div>

  <div id="pageContent" class="page-content">
    <header class="cc-header">
      <div>
        <h1 class="cc-title">Customer Command Center</h1>
        <p id="ccSubtitle" class="cc-subtitle">Loading...</p>
      </div>
      <div class="cc-actions">
        <a id="requestServiceLink" href="#" target="_blank" rel="noopener" class="cc-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
          Request Service
        </a>
      </div>
    </header>

    <section class="cc-stats">
      <div class="cc-stat">
        <div class="cc-stat-label">Total Doors</div>
        <div id="statDoors" class="cc-stat-value">—</div>
        <div class="cc-stat-hint">Doors in registry</div>
      </div>
      <div class="cc-stat">
        <div class="cc-stat-label">Passing</div>
        <div id="statPass" class="cc-stat-value good">—</div>
        <div class="cc-stat-hint">Compliant doors</div>
      </div>
      <div class="cc-stat">
        <div class="cc-stat-label">Failing</div>
        <div id="statFail" class="cc-stat-value fail">—</div>
        <div class="cc-stat-hint">Needs attention</div>
      </div>
      <div class="cc-stat">
        <div class="cc-stat-label">Service Tasks</div>
        <div id="statTasks" class="cc-stat-value">—</div>
        <div class="cc-stat-hint">In date range</div>
      </div>
    </section>

    <section class="cc-filters">
      <input id="qInput" class="cc-input search" type="text" placeholder="Search doors or tasks..." />
      <div class="cc-dates">
        <span class="cc-label">From</span>
        <input id="fromInput" class="cc-input" type="month" />
        <span class="cc-label">To</span>
        <input id="toInput" class="cc-input" type="month" />
      </div>
      <select id="statusInput" class="cc-select">
        <option value="">All Statuses</option>
        <option value="PASS">PASS</option>
        <option value="FAIL">FAIL</option>
      </select>
    </section>

    <section class="cc-card">
      <div class="cc-card-head">
        <div>
          <h2 class="cc-card-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
            Door Inspections
          </h2>
          <p class="cc-card-meta">Click a door ID to view details</p>
        </div>
        <div class="download-group">
          <button id="downloadDoorsCSV" class="cc-btn cc-btn--green">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            CSV
          </button>
          <button id="downloadDoorsPDF" class="cc-btn cc-btn--primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            PDF Report
          </button>
        </div>
      </div>
      <div class="cc-tablewrap">
        <table class="cc-table">
          <thead>
            <tr>
              <th>Door ID</th>
              <th>Status</th>
              <th>Last Inspection</th>
              <th>AAADM</th>
              <th>Location</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="doorsBody"></tbody>
        </table>
      </div>
      <div id="doorsMeta" class="cc-meta">Loading...</div>
    </section>

    <section class="cc-card">
      <div class="cc-card-head">
        <div>
          <h2 class="cc-card-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
            Service Activity
          </h2>
          <p class="cc-card-meta">Work orders and service history</p>
        </div>
        <div class="download-group">
          <button id="downloadTasksCSV" class="cc-btn cc-btn--green">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            CSV
          </button>
        </div>
      </div>
      <div class="cc-tablewrap">
        <table class="cc-table">
          <thead>
            <tr>
              <th>Service Date</th>
              <th>Technician</th>
              <th>Status</th>
              <th>Work Performed</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
      <div id="tasksMeta" class="cc-meta">Loading...</div>
    </section>
  </div>

  <div id="floatingUser" class="floating-user" style="display: none;">
    <div class="floating-user-info">
      <div id="floatingUserName" class="floating-user-name">User</div>
      <div id="floatingUserRole" class="floating-user-role">Role</div>
    </div>
    <button onclick="window.AASAuth?.logout()" title="Sign Out">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
    </button>
  </div>

  <script>
    const CUSTOMER_SOURCES = {
      manning: {
        label: "Manning Family Children's Hospital",
        tasksCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=1054197999&single=true&output=csv",
        inspectionsCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=2106704799&single=true&output=csv",
        requestServiceUrl: "https://app.limblecmms.com/loc-problem/wtwsbc13448/50187"
      }
    };

    function $(id) { return document.getElementById(id); }
    function clean(v) { return (v == null ? "" : String(v)).trim(); }
    function escapeHtml(s) { return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    function parseCSV(text) {
      const rows = []; let row = [], cell = "", inQ = false;
      const s = String(text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (inQ) {
          if (ch === '"') { if (s[i+1] === '"') { cell += '"'; i++; } else { inQ = false; } }
          else { cell += ch; }
        } else {
          if (ch === '"') { inQ = true; }
          else if (ch === ',') { row.push(cell); cell = ""; }
          else if (ch === '\n') { row.push(cell); if (row.some(v => v.trim())) rows.push(row); row = []; cell = ""; }
          else { cell += ch; }
        }
      }
      if (cell.length || row.length) { row.push(cell); if (row.some(v => v.trim())) rows.push(row); }
      return rows;
    }

    async function loadCSV(url) {
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`CSV fetch failed: ${resp.status}`);
      const rows = parseCSV(await resp.text());
      if (!rows.length) throw new Error("Empty CSV");
      const hdr = rows[0].map(h => clean(h));
      const ix = Object.fromEntries(hdr.map((h, i) => [h.toLowerCase(), i]));
      const col = (r, name) => {
        const i = ix[name.toLowerCase()];
        return i === undefined ? "" : clean(r[i] || "");
      };
      return { rows: rows.slice(1), hdr, col };
    }

    // Parse MM/YYYY or MM/DD/YYYY
    function parseDate(s) {
      const str = String(s || "").trim();
      // MM/YYYY format
      let m = str.match(/^(\d{1,2})\/(\d{4})$/);
      if (m) return { month: +m[1], year: +m[2], sortKey: +m[2] * 100 + +m[1] };
      // MM/DD/YYYY format
      m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        let year = +m[3]; if (year < 100) year += 2000;
        return { month: +m[1], year, sortKey: year * 10000 + +m[1] * 100 + +m[2] };
      }
      return null;
    }

    function parseMonthInput(s) {
      if (!s) return null;
      const m = s.match(/^(\d{4})-(\d{2})$/);
      if (!m) return null;
      return { month: +m[2], year: +m[1], sortKey: +m[1] * 100 + +m[2] };
    }

    function formatMonthYear(d) {
      if (!d) return "";
      return `${d.month}/${d.year}`;
    }

    function baseStatus(s) {
      const up = String(s || "").trim().toUpperCase();
      if (up.includes("PASS")) return "PASS";
      if (up.includes("FAIL")) return "FAIL";
      if (up.includes("OPEN")) return "OPEN";
      if (up.includes("COMPLETE")) return "COMPLETE";
      return up;
    }

    function statusClass(s) {
      const st = baseStatus(s);
      if (st === 'PASS') return 'pass';
      if (st === 'FAIL') return 'fail';
      if (st === 'OPEN') return 'open';
      if (st === 'COMPLETE') return 'complete';
      return '';
    }

    function downloadCSV(filename, rows) {
      const esc = v => `"${String(v ?? "").replace(/"/g, '""')}"`;
      const csv = rows.map(r => r.map(esc).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function generatePDF(title, summary, headers, data, filename) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });
      
      // Header
      doc.setFontSize(18);
      doc.setTextColor(0, 100, 150);
      doc.text(title, 14, 20);
      
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
      
      // Summary box
      doc.setFillColor(240, 248, 255);
      doc.rect(14, 32, 268, 20, 'F');
      doc.setFontSize(10);
      doc.setTextColor(50);
      let y = 38;
      summary.forEach((line, i) => {
        doc.text(line, 18, y + (i * 5));
      });
      
      // Table
      doc.autoTable({
        startY: 56,
        head: [headers],
        body: data,
        theme: 'striped',
        headStyles: { fillColor: [0, 120, 180], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 8, cellPadding: 3 },
        alternateRowStyles: { fillColor: [248, 250, 252] }
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Automatic Access Solutions • Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);
      }
      
      doc.save(filename);
    }

    // Main app state
    let tasks = [], doors = [], customerLabel = "";
    let fromFilter = null, toFilter = null;

    async function loadData(src) {
      $("doorsMeta").textContent = "Loading doors...";
      $("tasksMeta").textContent = "Loading tasks...";
      
      const [taskCSV, doorCSV] = await Promise.all([
        loadCSV(src.tasksCsv).catch(() => ({ rows: [], col: () => "" })),
        loadCSV(src.inspectionsCsv)
      ]);

      // Tasks
      tasks = taskCSV.rows.map(r => {
        const dateStr = taskCSV.col(r, "Service Date");
        return {
          dateStr,
          dateObj: parseDate(dateStr),
          tech: taskCSV.col(r, "Technician"),
          status: baseStatus(taskCSV.col(r, "Status & type")),
          summary: taskCSV.col(r, "Summary").replace(/<[^>]*>/g, "").trim()
        };
      }).filter(t => t.dateStr || t.summary);

      // Doors - using exact column names from your sheet
      doors = doorCSV.rows.map(r => ({
        doorId: doorCSV.col(r, "Door ID"),
        aaadm: doorCSV.col(r, "AAADM"),
        qrLink: doorCSV.col(r, "QR Link"),
        lastInspection: doorCSV.col(r, "Last Inspection"),
        dateObj: parseDate(doorCSV.col(r, "Last Inspection")),
        status: baseStatus(doorCSV.col(r, "Status")),
        tech: doorCSV.col(r, "Technician"),
        notes: doorCSV.col(r, "Notes"),
        retested: doorCSV.col(r, "Retested"),
        location: doorCSV.col(r, "Location")
      })).filter(d => d.doorId);

      console.log(`Loaded ${doors.length} doors, ${tasks.length} tasks`);
    }

    function getFilters() {
      const q = ($("qInput").value || "").toLowerCase().trim();
      const st = ($("statusInput").value || "").toUpperCase();
      const from = parseMonthInput($("fromInput").value);
      const to = parseMonthInput($("toInput").value);
      return { q, st, from, to };
    }

    function inDateRange(dateObj, from, to) {
      if (!from && !to) return true;
      if (!dateObj) return false;
      if (from && dateObj.sortKey < from.sortKey) return false;
      if (to && dateObj.sortKey > to.sortKey) return false;
      return true;
    }

    function getFilteredData() {
      const { q, st, from, to } = getFilters();
      
      const filteredDoors = doors.filter(d => {
        if (st && d.status !== st) return false;
        if (!inDateRange(d.dateObj, from, to)) return false;
        if (q) {
          const blob = `${d.doorId} ${d.location} ${d.notes} ${d.tech}`.toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      const filteredTasks = tasks.filter(t => {
        if (!inDateRange(t.dateObj, from, to)) return false;
        if (q) {
          const blob = `${t.summary} ${t.tech}`.toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      return { filteredDoors, filteredTasks };
    }

    function render() {
      const { filteredDoors, filteredTasks } = getFilteredData();
      const { from, to } = getFilters();

      // Stats
      const passCount = filteredDoors.filter(d => d.status === "PASS").length;
      const failCount = filteredDoors.filter(d => d.status === "FAIL").length;
      
      $("statDoors").textContent = filteredDoors.length;
      $("statPass").textContent = passCount;
      $("statFail").textContent = failCount;
      $("statFail").className = "cc-stat-value" + (failCount > 0 ? " fail" : " good");
      $("statTasks").textContent = filteredTasks.length;

      // Doors table
      const doorsBody = $("doorsBody");
      doorsBody.innerHTML = "";
      filteredDoors.forEach(d => {
        const notes = d.retested ? `${d.notes} [${d.retested}]` : d.notes;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><a href="/door/?id=${encodeURIComponent(d.doorId)}">${escapeHtml(d.doorId)}</a></td>
          <td><span class="status-badge ${statusClass(d.status)}">${escapeHtml(d.status)}</span></td>
          <td>${escapeHtml(d.lastInspection)}</td>
          <td>${escapeHtml(d.aaadm)}</td>
          <td>${escapeHtml(d.location)}</td>
          <td>${escapeHtml(notes)}</td>
        `;
        doorsBody.appendChild(tr);
      });
      $("doorsMeta").textContent = `${filteredDoors.length} doors • ${passCount} passing, ${failCount} failing`;

      // Tasks table
      const tasksBody = $("tasksBody");
      tasksBody.innerHTML = "";
      filteredTasks.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(t.dateStr)}</td>
          <td>${escapeHtml(t.tech)}</td>
          <td><span class="status-badge ${statusClass(t.status)}">${escapeHtml(t.status)}</span></td>
          <td>${escapeHtml(t.summary)}</td>
        `;
        tasksBody.appendChild(tr);
      });
      $("tasksMeta").textContent = `${filteredTasks.length} service records`;
    }

    function getDateRangeStr() {
      const from = $("fromInput").value;
      const to = $("toInput").value;
      if (from && to) return `${from.replace('-', '')}-to-${to.replace('-', '')}`;
      if (from) return `from-${from.replace('-', '')}`;
      if (to) return `to-${to.replace('-', '')}`;
      return new Date().toISOString().slice(0, 10);
    }

    function setupDownloads() {
      // Doors CSV
      $("downloadDoorsCSV").onclick = () => {
        const { filteredDoors } = getFilteredData();
        const rows = [["Door ID", "Status", "Last Inspection", "AAADM", "Location", "Technician", "Notes", "Retested"]];
        filteredDoors.forEach(d => {
          rows.push([d.doorId, d.status, d.lastInspection, d.aaadm, d.location, d.tech, d.notes, d.retested]);
        });
        downloadCSV(`manning-door-inspections-${getDateRangeStr()}.csv`, rows);
      };

      // Doors PDF
      $("downloadDoorsPDF").onclick = () => {
        const { filteredDoors } = getFilteredData();
        const passCount = filteredDoors.filter(d => d.status === "PASS").length;
        const failCount = filteredDoors.filter(d => d.status === "FAIL").length;
        
        const summary = [
          `Customer: ${customerLabel}`,
          `Total Doors: ${filteredDoors.length}  |  Passing: ${passCount}  |  Failing: ${failCount}`,
          `Date Range: ${$("fromInput").value || 'All'} to ${$("toInput").value || 'All'}`
        ];
        
        const headers = ["Door ID", "Status", "Last Insp", "AAADM", "Location", "Notes"];
        const data = filteredDoors.map(d => [
          d.doorId, d.status, d.lastInspection, d.aaadm, 
          d.location, d.retested ? `${d.notes} [${d.retested}]` : d.notes
        ]);
        
        generatePDF(
          "Door Inspection Report - Manning Family Children's Hospital",
          summary, headers, data,
          `manning-door-inspection-report-${getDateRangeStr()}.pdf`
        );
      };

      // Tasks CSV
      $("downloadTasksCSV").onclick = () => {
        const { filteredTasks } = getFilteredData();
        const rows = [["Service Date", "Technician", "Status", "Work Performed"]];
        filteredTasks.forEach(t => {
          rows.push([t.dateStr, t.tech, t.status, t.summary]);
        });
        downloadCSV(`manning-service-tasks-${getDateRangeStr()}.csv`, rows);
      };
    }

    async function initPage(user, roles) {
      const customerKey = "manning";
      const src = CUSTOMER_SOURCES[customerKey];
      customerLabel = src.label;

      $("ccSubtitle").textContent = `${user.name || user.email} • ${src.label}`;
      $("requestServiceLink").href = src.requestServiceUrl;

      // Default date range: last 3 months
      const now = new Date();
      const fromDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
      $("fromInput").value = `${fromDate.getFullYear()}-${String(fromDate.getMonth() + 1).padStart(2, '0')}`;
      $("toInput").value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      // Bind filters
      $("qInput").addEventListener("input", render);
      $("statusInput").addEventListener("change", render);
      $("fromInput").addEventListener("change", render);
      $("toInput").addEventListener("change", render);

      setupDownloads();

      try {
        await loadData(src);
        render();
      } catch (e) {
        console.error("[CC] Load error:", e);
        $("doorsMeta").textContent = "Error loading data.";
        $("tasksMeta").textContent = "Error loading data.";
      }
    }

    window.onPageReady = initPage;
  </script>
  <script src="/auth.js"></script>
</body>
</html>
