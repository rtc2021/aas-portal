<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manning Children's Portal â€¢ AAS</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* =========================
       CUSTOMER PORTAL v1 - Manning Children's Hospital
       Mobile-first with collapsible sections
       ========================= */

    .page-content { display: none; }

    :root {
      --cp-bg: #050508;
      --cp-surface: rgba(15, 15, 25, 0.85);
      --cp-card: rgba(25, 25, 40, 0.7);
      --cp-border: rgba(255, 255, 255, 0.08);
      --cp-border-hover: rgba(0, 212, 255, 0.4);
      --cp-text: #f5f5fa;
      --cp-text-secondary: #a0a0b0;
      --cp-text-muted: #606070;
      --cp-accent: #00d4ff;
      --cp-accent-bg: rgba(0, 212, 255, 0.12);
      --cp-green: #22c55e;
      --cp-green-bg: rgba(34, 197, 94, 0.15);
      --cp-amber: #f59e0b;
      --cp-amber-bg: rgba(245, 158, 11, 0.15);
      --cp-red: #ef4444;
      --cp-red-bg: rgba(239, 68, 68, 0.15);
      --cp-input-bg: rgba(25, 25, 40, 0.7);
      --cp-glow: 0 0 40px rgba(0, 212, 255, 0.25);
    }

    body.light-theme {
      --cp-bg: #f4f6f8;
      --cp-surface: rgba(255, 255, 255, 1);
      --cp-card: #ffffff;
      --cp-border: rgba(0, 0, 0, 0.1);
      --cp-border-hover: rgba(0, 119, 170, 0.4);
      --cp-text: #1a1a2e;
      --cp-text-secondary: rgba(26, 26, 46, 0.75);
      --cp-text-muted: rgba(26, 26, 46, 0.55);
      --cp-accent: #0077aa;
      --cp-accent-bg: rgba(0, 119, 170, 0.1);
      --cp-green: #16a34a;
      --cp-green-bg: rgba(22, 163, 74, 0.12);
      --cp-amber: #d97706;
      --cp-amber-bg: rgba(217, 119, 6, 0.12);
      --cp-red: #dc2626;
      --cp-red-bg: rgba(220, 38, 38, 0.12);
      --cp-input-bg: #ffffff;
      --cp-glow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--cp-bg);
      color: var(--cp-text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-effects {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
    }
    .bg-effects::before {
      content: '';
      position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
      animation: bgPulse 15s ease-in-out infinite;
    }
    body.light-theme .bg-effects { display: none; }
    @keyframes bgPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

    .auth-overlay { position: fixed; inset: 0; background: var(--cp-bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-overlay.hidden { display: none; }
    .auth-card { text-align: center; padding: 48px; background: var(--cp-surface); backdrop-filter: blur(20px); border: 1px solid var(--cp-border); border-radius: 24px; max-width: 420px; }
    .auth-card img { height: 48px; margin-bottom: 24px; }
    .auth-title { font-size: 24px; font-weight: 700; margin: 0 0 8px; display: none; color: var(--cp-text); }
    .auth-subtitle { color: var(--cp-text-secondary); margin: 0 0 28px; font-size: 15px; display: none; }
    .auth-btn { display: none; background: linear-gradient(135deg, var(--cp-accent), #0099cc); color: #fff; border: none; padding: 16px 40px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .auth-spinner { width: 48px; height: 48px; border: 3px solid var(--cp-border); border-top-color: var(--cp-accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .portal {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .jump-nav {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .jump-nav::-webkit-scrollbar { display: none; }

    .jump-btn {
      flex-shrink: 0;
      padding: 8px 14px;
      background: transparent;
      border: 1px solid var(--cp-border);
      border-radius: 8px;
      color: var(--cp-text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .jump-btn:hover, .jump-btn.active {
      background: var(--cp-accent-bg);
      border-color: var(--cp-accent);
      color: var(--cp-accent);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding-top: 50px;
    }

    .header-info h1 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--cp-text) 0%, var(--cp-accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-info .subtitle {
      color: var(--cp-text-muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .customer-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: var(--cp-accent-bg);
      border: 1px solid var(--cp-accent);
      border-radius: 20px;
      color: var(--cp-accent);
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px 16px;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 16px;
      color: var(--cp-text);
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      border-color: var(--cp-border-hover);
      box-shadow: var(--cp-glow);
      transform: translateY(-2px);
    }
    .action-btn svg {
      width: 28px;
      height: 28px;
      color: var(--cp-accent);
    }
    .action-btn.primary {
      background: linear-gradient(135deg, var(--cp-accent), #0099cc);
      color: #fff;
      border: none;
    }
    .action-btn.primary svg { color: #fff; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 16px;
      padding: 16px;
    }

    .stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--cp-text-muted);
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--cp-accent);
      margin: 4px 0;
    }
    .stat-value.good { color: var(--cp-green); }
    .stat-value.warn { color: var(--cp-amber); }
    .stat-value.fail { color: var(--cp-red); }

    .stat-hint {
      font-size: 0.7rem;
      color: var(--cp-text-muted);
    }

    .section {
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 20px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .section-header:hover { background: var(--cp-accent-bg); }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 700;
      color: var(--cp-text);
    }
    .section-title svg {
      width: 20px;
      height: 20px;
      color: var(--cp-accent);
    }

    .section-meta {
      font-size: 0.75rem;
      color: var(--cp-text-muted);
    }

    .section-toggle {
      width: 24px;
      height: 24px;
      color: var(--cp-text-muted);
      transition: transform 0.3s;
    }
    .section.collapsed .section-toggle { transform: rotate(-90deg); }

    .section-body {
      padding: 0 20px 20px;
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .section.collapsed .section-body {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }

    .filter-input, .filter-select {
      flex: 1;
      min-width: 120px;
      height: 40px;
      padding: 8px 12px;
      background: var(--cp-input-bg);
      border: 1px solid var(--cp-border);
      border-radius: 10px;
      color: var(--cp-text);
      font-size: 0.85rem;
    }
    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--cp-accent);
    }

    .date-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .date-label {
      font-size: 0.7rem;
      color: var(--cp-text-muted);
    }

    .table-wrap {
      overflow-x: auto;
      border-radius: 12px;
      max-height: 400px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .data-table thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--cp-bg);
      color: var(--cp-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid var(--cp-border);
    }

    .data-table td {
      padding: 10px;
      border-bottom: 1px solid var(--cp-border);
      vertical-align: top;
      color: var(--cp-text-secondary);
    }

    .data-table tbody tr:hover td { background: rgba(0, 212, 255, 0.03); }

    .data-table a {
      color: var(--cp-accent);
      text-decoration: none;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.pass { background: var(--cp-green-bg); color: var(--cp-green); }
    .badge.fail { background: var(--cp-red-bg); color: var(--cp-red); }
    .badge.open { background: var(--cp-amber-bg); color: var(--cp-amber); }
    .badge.complete { background: var(--cp-accent-bg); color: var(--cp-accent); }

    .download-group { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cp-surface);
      border: 1px solid var(--cp-border);
      border-radius: 8px;
      color: var(--cp-text);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { border-color: var(--cp-border-hover); }
    .btn svg { width: 14px; height: 14px; }
    .btn.green { background: var(--cp-green-bg); border-color: var(--cp-green); color: var(--cp-green); }
    .btn.primary { background: linear-gradient(135deg, var(--cp-accent), #0099cc); color: #fff; border: none; }

    .floating-user {
      position: fixed;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 50px;
      z-index: 100;
    }
    .floating-user-info { text-align: right; }
    .floating-user-name { font-size: 0.8rem; font-weight: 600; color: var(--cp-text); }
    .floating-user-role { font-size: 0.65rem; color: var(--cp-accent); text-transform: uppercase; letter-spacing: 0.05em; }
    .floating-user button {
      background: none;
      border: none;
      color: var(--cp-text-muted);
      cursor: pointer;
      padding: 5px;
      display: flex;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .floating-user button:hover { background: var(--cp-red-bg); color: var(--cp-red); }
    .floating-user svg { width: 16px; height: 16px; }

    @media (max-width: 720px) {
      .table-wrap { max-height: none !important; overflow: visible !important; }
      .data-table thead { display: none !important; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block !important;
        width: 100% !important;
      }
      .data-table tbody tr {
        margin: 10px 0 !important;
        padding: 14px !important;
        border-radius: 14px !important;
        border: 1px solid var(--cp-border) !important;
        background: var(--cp-card) !important;
      }
      .data-table tbody td {
        border: 0 !important;
        padding: 6px 0 !important;
        border-bottom: 1px solid var(--cp-border) !important;
      }
      .data-table tbody td:last-child { border-bottom: 0 !important; }
      .data-table tbody td::before {
        display: block;
        margin-bottom: 3px;
        font-size: 0.6rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--cp-text-muted);
        font-weight: 600;
      }
      #doorsBody td:nth-child(1)::before { content: "Door ID"; }
      #doorsBody td:nth-child(2)::before { content: "Status"; }
      #doorsBody td:nth-child(3)::before { content: "Last Inspection"; }
      #doorsBody td:nth-child(4)::before { content: "AAADM"; }
      #doorsBody td:nth-child(5)::before { content: "Location"; }
      #doorsBody td:nth-child(6)::before { content: "Notes"; }
      #tasksBody td:nth-child(1)::before { content: "Date"; }
      #tasksBody td:nth-child(2)::before { content: "Task"; }
      #tasksBody td:nth-child(3)::before { content: "Technician"; }
      #tasksBody td:nth-child(4)::before { content: "Status"; }
      #tasksBody td:nth-child(5)::before { content: "Work Performed"; }
      .filters { flex-direction: column; }
      .date-group { flex-wrap: wrap; }
      .floating-user-name, .floating-user-role { display: none; }
    }

    @media (min-width: 768px) {
      .portal { padding: 24px; }
      .stats-grid { grid-template-columns: repeat(4, 1fr); }
      .quick-actions { grid-template-columns: repeat(4, 1fr); }
      .header { padding-top: 0; }
    }

    @media (min-width: 900px) {
      .jump-nav { display: none; }
    }
  </style>
</head>
<body>
  <div class="bg-effects"></div>

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <img src="https://images.squarespace-cdn.com/content/53292562e4b06710691770b4/c75debc4-7194-4008-875d-856c6fa3b205/dis+lis+logo.webp?content-type=image%2Fwebp" alt="AAS">
      <div class="auth-spinner"></div>
      <p id="authLoadingText" style="color: var(--cp-text-muted);">Loading...</p>
      <h1 class="auth-title">Sign In Required</h1>
      <p class="auth-subtitle">Please sign in to access your portal</p>
      <button id="authLoginBtn" class="auth-btn">Sign In</button>
    </div>
  </div>

  <div id="pageContent" class="page-content">
    <div class="portal">
      <nav class="jump-nav">
        <button class="jump-btn active" data-section="stats">Overview</button>
        <button class="jump-btn" data-section="doors">Doors</button>
        <button class="jump-btn" data-section="tasks">Service</button>
        <button class="jump-btn" data-section="actions">Actions</button>
      </nav>

      <header class="header" id="stats">
        <div class="header-info">
          <h1>Manning Children's</h1>
          <p class="subtitle" id="userGreeting">Welcome back</p>
          <div class="customer-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Manning Family Children's Hospital
          </div>
        </div>
      </header>

      <section class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Openings</div>
          <div class="stat-value" id="statDoors">--</div>
          <div class="stat-hint" id="statDoorsHint">-- door leaves</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Compliance</div>
          <div class="stat-value good" id="statCompliance">--</div>
          <div class="stat-hint">NFPA 80</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Passing</div>
          <div class="stat-value good" id="statPass">--</div>
          <div class="stat-hint">Compliant</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Failing</div>
          <div class="stat-value fail" id="statFail">--</div>
          <div class="stat-hint">Needs attention</div>
        </div>
      </section>

      <section class="quick-actions" id="actions">
        <a href="https://app.limblecmms.com/problem/wtwsbc13448/50187/3" target="_blank" rel="noopener" class="action-btn primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Request Service
        </a>
        <a href="sms:+15048105285?body=Manning%20Childrens%20Service%20Request:%20" class="action-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Text AAS
        </a>
        <a href="tel:+15048105285" class="action-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          Call AAS
        </a>
        <button class="action-btn" id="downloadReportBtn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          PDF Report
        </button>
      </section>

      <section class="section" id="doors">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Door Inspections
            </h2>
            <p class="section-meta" id="doorsMeta">Loading...</p>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <div class="filters">
            <input id="doorSearch" class="filter-input" type="text" placeholder="Search doors..." />
            <select id="doorStatusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="PASS">PASS</option>
              <option value="FAIL">FAIL</option>
            </select>
          </div>
          <div class="download-group" style="margin-bottom: 12px;">
            <button id="downloadDoorsCSV" class="btn green">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              CSV
            </button>
            <button id="downloadDoorsPDF" class="btn primary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              PDF
            </button>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Door ID</th>
                  <th>Status</th>
                  <th>Last Inspection</th>
                  <th>AAADM</th>
                  <th>Location</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="doorsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="section" id="tasks">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
              </svg>
              Service Activity
            </h2>
            <p class="section-meta" id="tasksMeta">Loading...</p>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <div class="filters">
            <input id="taskSearch" class="filter-input" type="text" placeholder="Search tasks..." />
            <select id="taskStatusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="COMPLETE">COMPLETE</option>
              <option value="OPEN">OPEN</option>
            </select>
            <div class="date-group">
              <span class="date-label">From</span>
              <input id="fromInput" class="filter-input" type="date" style="min-width: 130px;" />
              <span class="date-label">To</span>
              <input id="toInput" class="filter-input" type="date" style="min-width: 130px;" />
            </div>
          </div>
          <div class="download-group" style="margin-bottom: 12px;">
            <button id="downloadTasksCSV" class="btn green">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              CSV
            </button>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Task</th>
                  <th>Technician</th>
                  <th>Status</th>
                  <th>Work Performed</th>
                </tr>
              </thead>
              <tbody id="tasksBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="floatingUser" class="floating-user" style="display: none;">
    <div class="floating-user-info">
      <div id="floatingUserName" class="floating-user-name">User</div>
      <div id="floatingUserRole" class="floating-user-role">Customer</div>
    </div>
    <button onclick="window.AASAuth?.logout()" title="Sign Out">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
    </button>
  </div>

  <script>
    // Manning Children's Hospital Customer Portal
    const CUSTOMER_KEY = 'manning';
    const CUSTOMER_LABEL = "Manning Family Children's Hospital";
    const DOOR_PREFIX = 'MH-';
    const TASKS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=1054197999&single=true&output=csv';
    const INSPECTIONS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=2106704799&single=true&output=csv';

    function $(id) { return document.getElementById(id); }
    function clean(v) { return (v == null ? '' : String(v)).trim(); }
    function escapeHtml(s) { return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function stripHtml(s) { return String(s || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim(); }

    function parseCSV(text) {
      const rows = []; let row = [], cell = '', inQ = false;
      const s = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (inQ) {
          if (ch === '"') { if (s[i+1] === '"') { cell += '"'; i++; } else { inQ = false; } }
          else { cell += ch; }
        } else {
          if (ch === '"') { inQ = true; }
          else if (ch === ',') { row.push(cell); cell = ''; }
          else if (ch === '\n') { row.push(cell); if (row.some(v => v.trim())) rows.push(row); row = []; cell = ''; }
          else { cell += ch; }
        }
      }
      if (cell.length || row.length) { row.push(cell); if (row.some(v => v.trim())) rows.push(row); }
      return rows;
    }

    async function loadCSV(url) {
      if (!url) return { rows: [], hdr: [], col: () => '' };
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`CSV fetch failed: ${resp.status}`);
      const text = await resp.text();
      const rows = parseCSV(text);
      if (!rows.length) throw new Error('Empty CSV');
      const hdr = rows[0].map(h => clean(h));
      const ix = Object.fromEntries(hdr.map((h, i) => [h.toLowerCase(), i]));
      const col = (r, name) => {
        const i = ix[name.toLowerCase()];
        return i === undefined ? '' : clean(r[i] || '');
      };
      return { rows: rows.slice(1), hdr, col };
    }

    function parseDate(s) {
      const str = String(s || '').trim();
      let m = str.match(/^(\d{1,2})\/(\d{4})$/);
      if (m) return { month: +m[1], year: +m[2], day: 1, sortKey: +m[2] * 10000 + +m[1] * 100, display: str };
      m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        let year = +m[3]; if (year < 100) year += 2000;
        return { month: +m[1], year, day: +m[2], sortKey: year * 10000 + +m[1] * 100 + +m[2], display: str };
      }
      return null;
    }

    function parseDateInput(s) {
      if (!s) return null;
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      return { year: +m[1], month: +m[2], day: +m[3], sortKey: +m[1] * 10000 + +m[2] * 100 + +m[3] };
    }

    function baseStatus(s) {
      const up = String(s || '').trim().toUpperCase();
      if (up.includes('PASS')) return 'PASS';
      if (up.includes('FAIL')) return 'FAIL';
      if (up.includes('COMPLETE')) return 'COMPLETE';
      if (up.includes('OPEN')) return 'OPEN';
      return up;
    }

    function statusClass(s) {
      const st = baseStatus(s);
      if (st === 'PASS') return 'pass';
      if (st === 'FAIL') return 'fail';
      if (st === 'OPEN') return 'open';
      if (st === 'COMPLETE') return 'complete';
      return '';
    }

    function downloadCSV(filename, rows) {
      const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const csv = rows.map(r => r.map(esc).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function generateCompliancePDF(title, customer, summary, headers, data, compliancePct, filename) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      doc.setFontSize(20);
      doc.setTextColor(0, 80, 120);
      doc.text(title, 14, 18);

      doc.setFontSize(14);
      doc.setTextColor(60);
      doc.text(customer, 14, 28);

      const badgeColor = compliancePct >= 90 ? [34, 197, 94] : compliancePct >= 70 ? [245, 158, 11] : [239, 68, 68];
      doc.setFillColor(...badgeColor);
      doc.roundedRect(220, 12, 60, 20, 3, 3, 'F');
      doc.setFontSize(16);
      doc.setTextColor(255);
      doc.text(`${compliancePct}% Compliant`, 225, 25);

      doc.setFillColor(245, 247, 250);
      doc.rect(14, 34, 268, 50, 'F');
      doc.setDrawColor(200);
      doc.rect(14, 34, 268, 50, 'S');

      doc.setFontSize(9);
      doc.setTextColor(50);
      let yPos = 42;
      summary.forEach((line) => {
        if (line.startsWith('REGULATORY') || line.startsWith('â€¢')) {
          doc.setFont(undefined, line.startsWith('REGULATORY') ? 'bold' : 'normal');
        }
        doc.text(line, 18, yPos);
        yPos += 5;
      });
      doc.setFont(undefined, 'normal');

      doc.autoTable({
        startY: 90,
        head: [headers],
        body: data,
        theme: 'striped',
        headStyles: { fillColor: [0, 100, 140], textColor: 255, fontStyle: 'bold', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3 },
        alternateRowStyles: { fillColor: [248, 250, 252] },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 20 },
          2: { cellWidth: 25 },
          3: { cellWidth: 20 },
          4: { cellWidth: 50 },
          5: { cellWidth: 'auto' }
        }
      });

      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(120);
        doc.text(`Automatic Access Solutions â€¢ Fire Door Inspection Report â€¢ Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 220, doc.internal.pageSize.height - 10);
      }

      doc.save(filename);
    }

    function toggleSection(section) {
      section.classList.toggle('collapsed');
    }

    function setupJumpNav() {
      const buttons = document.querySelectorAll('.jump-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const sectionId = btn.dataset.section;
          const section = document.getElementById(sectionId);
          if (section) {
            if (section.classList.contains('collapsed')) {
              section.classList.remove('collapsed');
            }
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          }
        });
      });

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            buttons.forEach(b => {
              b.classList.toggle('active', b.dataset.section === id);
            });
          }
        });
      }, { threshold: 0.3 });

      ['stats', 'doors', 'tasks', 'actions'].forEach(id => {
        const el = document.getElementById(id);
        if (el) observer.observe(el);
      });
    }

    let tasks = [], doors = [];

    async function loadData() {
      $('doorsMeta').textContent = 'Loading doors...';
      $('tasksMeta').textContent = 'Loading tasks...';

      let taskCSV = { rows: [], col: () => '' };
      let doorCSV;

      try {
        doorCSV = await loadCSV(INSPECTIONS_CSV);
      } catch (e) {
        console.error('[Portal] Door CSV error:', e);
        $('doorsMeta').textContent = 'Error loading door data';
        return;
      }

      try {
        taskCSV = await loadCSV(TASKS_CSV);
      } catch (e) {
        console.error('[Portal] Task CSV error:', e);
        $('tasksMeta').textContent = 'Error loading tasks';
      }

      tasks = taskCSV.rows.map(r => ({
        taskId: taskCSV.col(r, 'Task ID'),
        dateStr: taskCSV.col(r, 'Service Date'),
        dateObj: parseDate(taskCSV.col(r, 'Service Date')),
        tech: taskCSV.col(r, 'Technician'),
        status: baseStatus(taskCSV.col(r, 'Status & type')),
        summary: stripHtml(taskCSV.col(r, 'Summary')),
        taskName: taskCSV.col(r, 'Task Name') || taskCSV.col(r, 'Location Name'),
        woLink: taskCSV.col(r, 'WO Link')
      })).filter(t => t.taskId || t.dateStr || t.summary);

      console.log('[Portal] Loaded', tasks.length, 'tasks');

      doors = doorCSV.rows.map(r => ({
        doorId: doorCSV.col(r, 'Door ID'),
        aaadm: doorCSV.col(r, 'AAADM'),
        qrLink: doorCSV.col(r, 'QR Link'),
        lastInspection: doorCSV.col(r, 'Last Inspection'),
        dateObj: parseDate(doorCSV.col(r, 'Last Inspection')),
        status: baseStatus(doorCSV.col(r, 'Status')),
        tech: doorCSV.col(r, 'Technician'),
        notes: doorCSV.col(r, 'Notes'),
        retested: doorCSV.col(r, 'Retested'),
        location: doorCSV.col(r, 'Location')
      })).filter(d => d.doorId && d.doorId.startsWith(DOOR_PREFIX));

      console.log('[Portal] Loaded', doors.length, 'doors for', DOOR_PREFIX);
    }

    function getFilters() {
      const doorQ = ($('doorSearch').value || '').toLowerCase().trim();
      const taskQ = ($('taskSearch').value || '').toLowerCase().trim();
      const doorStatus = ($('doorStatusFilter').value || '').toUpperCase();
      const taskStatus = ($('taskStatusFilter').value || '').toUpperCase();
      const from = parseDateInput($('fromInput').value);
      const to = parseDateInput($('toInput').value);
      return { doorQ, taskQ, doorStatus, taskStatus, from, to };
    }

    function inDateRange(dateObj, from, to) {
      if (!from && !to) return true;
      if (!dateObj) return false;
      if (from && dateObj.sortKey < from.sortKey) return false;
      if (to && dateObj.sortKey > to.sortKey) return false;
      return true;
    }

    function countDoors(doorsArr) {
      let openings = doorsArr.length;
      let doorLeaves = 0;
      doorsArr.forEach(door => {
        const name = door.doorId || '';
        if (name.includes('/')) {
          doorLeaves += 2;
        } else {
          doorLeaves += 1;
        }
      });
      return { openings, doorLeaves };
    }

    function getFilteredData() {
      const { doorQ, taskQ, doorStatus, taskStatus, from, to } = getFilters();

      const filteredDoors = doors.filter(d => {
        if (doorStatus && d.status !== doorStatus) return false;
        if (doorQ) {
          const blob = `${d.doorId} ${d.location} ${d.notes} ${d.tech}`.toLowerCase();
          if (!blob.includes(doorQ)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      const filteredTasks = tasks.filter(t => {
        if (taskStatus) {
          if (taskStatus === 'COMPLETE' && t.status !== 'COMPLETE') return false;
          if (taskStatus === 'OPEN' && t.status === 'COMPLETE') return false;
        }
        if (!inDateRange(t.dateObj, from, to)) return false;
        if (taskQ) {
          const blob = `${t.summary} ${t.tech} ${t.taskName}`.toLowerCase();
          if (!blob.includes(taskQ)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      return { filteredDoors, filteredTasks };
    }

    function render() {
      const { filteredDoors, filteredTasks } = getFilteredData();

      const passCount = filteredDoors.filter(d => d.status === 'PASS').length;
      const failCount = filteredDoors.filter(d => d.status === 'FAIL').length;
      const totalWithStatus = passCount + failCount;
      const compliancePct = totalWithStatus > 0 ? Math.round((passCount / totalWithStatus) * 100) : 0;

      // Count openings vs door leaves
      const { openings, doorLeaves } = countDoors(filteredDoors);

      $('statDoors').textContent = openings;
      $('statDoorsHint').textContent = `${doorLeaves} door leaves`;
      $('statCompliance').textContent = compliancePct + '%';
      $('statCompliance').className = 'stat-value' + (compliancePct >= 90 ? ' good' : compliancePct >= 70 ? ' warn' : ' fail');
      $('statPass').textContent = passCount;
      $('statFail').textContent = failCount;
      $('statFail').className = 'stat-value' + (failCount > 0 ? ' fail' : ' good');

      const doorsBody = $('doorsBody');
      doorsBody.innerHTML = '';
      if (filteredDoors.length === 0) {
        doorsBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--cp-text-muted);padding:30px;">No doors match filters</td></tr>';
      } else {
        filteredDoors.forEach(d => {
          const notes = d.retested ? `${d.notes} [${d.retested}]` : d.notes;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><a href="/door/?id=${encodeURIComponent(d.doorId)}">${escapeHtml(d.doorId)}</a></td>
            <td><span class="badge ${statusClass(d.status)}">${escapeHtml(d.status)}</span></td>
            <td>${escapeHtml(d.lastInspection)}</td>
            <td>${escapeHtml(d.aaadm)}</td>
            <td>${escapeHtml(d.location)}</td>
            <td>${escapeHtml(notes)}</td>
          `;
          doorsBody.appendChild(tr);
        });
      }
      $('doorsMeta').textContent = `${openings} Openings (${doorLeaves} Doors) â€¢ ${passCount} passing, ${failCount} failing`;

      // Update jump nav doors button
      const doorsJumpBtn = document.querySelector('.jump-btn[data-section="doors"]');
      if (doorsJumpBtn) doorsJumpBtn.textContent = `ðŸšª ${openings} Openings (${doorLeaves} Doors)`;

      const tasksBody = $('tasksBody');
      tasksBody.innerHTML = '';
      if (filteredTasks.length === 0) {
        tasksBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--cp-text-muted);padding:30px;">No tasks match filters</td></tr>';
      } else {
        filteredTasks.forEach(t => {
          const tr = document.createElement('tr');
          const taskLink = t.woLink ? `<a href="${escapeHtml(t.woLink)}" target="_blank">${escapeHtml(t.taskName || t.taskId)}</a>` : escapeHtml(t.taskName || t.taskId);
          tr.innerHTML = `
            <td>${escapeHtml(t.dateStr)}</td>
            <td>${taskLink}</td>
            <td>${escapeHtml(t.tech)}</td>
            <td><span class="badge ${statusClass(t.status)}">${escapeHtml(t.status)}</span></td>
            <td>${escapeHtml(t.summary)}</td>
          `;
          tasksBody.appendChild(tr);
        });
      }
      $('tasksMeta').textContent = `${filteredTasks.length} service records`;
    }

    function getDateRangeStr() {
      const from = $('fromInput').value;
      const to = $('toInput').value;
      if (from && to) return `${from}-to-${to}`;
      if (from) return `from-${from}`;
      if (to) return `to-${to}`;
      return new Date().toISOString().slice(0, 10);
    }

    function setupDownloads() {
      $('downloadDoorsCSV').onclick = () => {
        const { filteredDoors } = getFilteredData();
        const rows = [['Door ID', 'Status', 'Last Inspection', 'AAADM', 'Location', 'Notes', 'Retested']];
        filteredDoors.forEach(d => {
          rows.push([d.doorId, d.status, d.lastInspection, d.aaadm, d.location, d.notes, d.retested]);
        });
        downloadCSV(`manning-childrens-doors-${getDateRangeStr()}.csv`, rows);
      };

      $('downloadDoorsPDF').onclick = generateFullReport;
      $('downloadReportBtn').onclick = generateFullReport;

      $('downloadTasksCSV').onclick = () => {
        const { filteredTasks } = getFilteredData();
        const rows = [['Task ID', 'Service Date', 'Task Name', 'Technician', 'Status', 'Work Performed']];
        filteredTasks.forEach(t => {
          rows.push([t.taskId, t.dateStr, t.taskName, t.tech, t.status, t.summary]);
        });
        downloadCSV(`manning-childrens-service-${getDateRangeStr()}.csv`, rows);
      };
    }

    function generateFullReport() {
      const { filteredDoors } = getFilteredData();
      const passCount = filteredDoors.filter(d => d.status === 'PASS').length;
      const failCount = filteredDoors.filter(d => d.status === 'FAIL').length;
      const totalWithStatus = passCount + failCount;
      const compliancePct = totalWithStatus > 0 ? Math.round((passCount / totalWithStatus) * 100) : 0;

      const { openings, doorLeaves } = countDoors(filteredDoors);
      const summary = [
        `Customer: ${CUSTOMER_LABEL}`,
        `Openings: ${openings} (${doorLeaves} Door Leaves)  |  Passing: ${passCount}  |  Failing: ${failCount}  |  Compliance: ${compliancePct}%`,
        `Report Date: ${new Date().toLocaleDateString()}`,
        ``,
        `REGULATORY STANDARDS:`,
        `â€¢ NFPA 80: Standard for Fire Doors and Other Opening Protectives`,
        `  Requires annual inspection of all fire door assemblies.`,
        `â€¢ Joint Commission EC.02.03.05 EP-25:`,
        `  Fire door assemblies must be inspected and tested annually per NFPA 80.`
      ];

      const headers = ['Door ID', 'Status', 'Last Insp', 'AAADM', 'Location', 'Notes'];
      const data = filteredDoors.map(d => [
        d.doorId, d.status, d.lastInspection, d.aaadm,
        d.location, d.retested ? `${d.notes} [${d.retested}]` : d.notes
      ]);

      generateCompliancePDF(
        'Fire Door Inspection Report',
        CUSTOMER_LABEL,
        summary, headers, data,
        compliancePct,
        `manning-childrens-inspection-report-${getDateRangeStr()}.pdf`
      );
    }

    async function initPage(user, roles, customerId) {
      console.log('[Portal] Init for', user?.email, 'customer:', customerId);

      $('userGreeting').textContent = `Welcome, ${user?.name || user?.email || 'Customer'}`;

      const now = new Date();
      const fromDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      $('fromInput').value = fromDate.toISOString().slice(0, 10);
      $('toInput').value = now.toISOString().slice(0, 10);

      $('doorSearch').addEventListener('input', render);
      $('taskSearch').addEventListener('input', render);
      $('doorStatusFilter').addEventListener('change', render);
      $('taskStatusFilter').addEventListener('change', render);
      $('fromInput').addEventListener('change', render);
      $('toInput').addEventListener('change', render);

      setupDownloads();
      setupJumpNav();

      try {
        await loadData();
        render();
      } catch (e) {
        console.error('[Portal] Load error:', e);
        $('doorsMeta').textContent = 'Error loading data';
        $('tasksMeta').textContent = 'Error loading data';
      }
    }

    window.onPageReady = initPage;
  </script>
  <script src="/auth.js"></script>
  <script src="/theme.js" defer></script>
  <script src="/copilot.js" defer></script>
</body>
</html>
