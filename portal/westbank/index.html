<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ochsner Westbank Portal ‚Ä¢ AAS</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* =========================
       CUSTOMER PORTAL v1 - Ochsner Westbank
       Mobile-first with collapsible sections
       ========================= */

    .page-content { display: none; }

    :root {
      --cp-bg: #050508;
      --cp-surface: rgba(15, 15, 25, 0.85);
      --cp-card: rgba(25, 25, 40, 0.7);
      --cp-border: rgba(255, 255, 255, 0.08);
      --cp-border-hover: rgba(0, 212, 255, 0.4);
      --cp-text: #f5f5fa;
      --cp-text-secondary: #a0a0b0;
      --cp-text-muted: #606070;
      --cp-accent: #00d4ff;
      --cp-accent-bg: rgba(0, 212, 255, 0.12);
      --cp-green: #22c55e;
      --cp-green-bg: rgba(34, 197, 94, 0.15);
      --cp-amber: #f59e0b;
      --cp-amber-bg: rgba(245, 158, 11, 0.15);
      --cp-red: #ef4444;
      --cp-red-bg: rgba(239, 68, 68, 0.15);
      --cp-input-bg: rgba(25, 25, 40, 0.7);
      --cp-glow: 0 0 40px rgba(0, 212, 255, 0.25);
    }

    body.light-theme {
      --cp-bg: #f4f6f8;
      --cp-surface: rgba(255, 255, 255, 1);
      --cp-card: #ffffff;
      --cp-border: rgba(0, 0, 0, 0.1);
      --cp-border-hover: rgba(0, 119, 170, 0.4);
      --cp-text: #1a1a2e;
      --cp-text-secondary: rgba(26, 26, 46, 0.75);
      --cp-text-muted: rgba(26, 26, 46, 0.55);
      --cp-accent: #0077aa;
      --cp-accent-bg: rgba(0, 119, 170, 0.1);
      --cp-green: #16a34a;
      --cp-green-bg: rgba(22, 163, 74, 0.12);
      --cp-amber: #d97706;
      --cp-amber-bg: rgba(217, 119, 6, 0.12);
      --cp-red: #dc2626;
      --cp-red-bg: rgba(220, 38, 38, 0.12);
      --cp-input-bg: #ffffff;
      --cp-glow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--cp-bg);
      color: var(--cp-text);
      min-height: 100vh;
    }

    .bg-effects {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
    }
    .bg-effects::before {
      content: '';
      position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
      animation: bgPulse 15s ease-in-out infinite;
    }
    body.light-theme .bg-effects { display: none; }
    @keyframes bgPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

    /* Auth overlay */
    .auth-overlay { position: fixed; inset: 0; background: var(--cp-bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-overlay.hidden { display: none; }
    .auth-card { text-align: center; padding: 48px; background: var(--cp-surface); backdrop-filter: blur(20px); border: 1px solid var(--cp-border); border-radius: 24px; max-width: 420px; }
    .auth-card img { height: 48px; margin-bottom: 24px; }
    .auth-title { font-size: 24px; font-weight: 700; margin: 0 0 8px; display: none; color: var(--cp-text); }
    .auth-subtitle { color: var(--cp-text-secondary); margin: 0 0 28px; font-size: 15px; display: none; }
    .auth-btn { display: none; background: linear-gradient(135deg, var(--cp-accent), #0099cc); color: #fff; border: none; padding: 16px 40px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .auth-spinner { width: 48px; height: 48px; border: 3px solid var(--cp-border); border-top-color: var(--cp-accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Main container */
    .portal {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Jump Nav - Mobile sticky nav */
    .jump-nav {
      position: sticky;
      top: 70px;
      z-index: 50;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .jump-nav::-webkit-scrollbar { display: none; }

    @media (max-width: 768px) {
      .jump-nav {
        position: relative;
        top: auto;
        z-index: 10;
        padding: 10px;
        margin-top: 60px;
      }
      #floatingUser {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.8rem;
        z-index: 100;
      }
    }

    .jump-btn {
      flex-shrink: 0;
      padding: 8px 14px;
      background: transparent;
      border: 1px solid var(--cp-border);
      border-radius: 8px;
      color: var(--cp-text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .jump-btn:hover, .jump-btn.active {
      background: var(--cp-accent-bg);
      border-color: var(--cp-accent);
      color: var(--cp-accent);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding-top: 50px;
    }

    .header-info h1 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--cp-text) 0%, var(--cp-accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-info .subtitle {
      color: var(--cp-text-muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .customer-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: var(--cp-accent-bg);
      border: 1px solid var(--cp-accent);
      border-radius: 20px;
      color: var(--cp-accent);
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 8px;
    }

    /* Quick Actions - Large touch targets for mobile */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px 16px;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 16px;
      color: var(--cp-text);
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      border-color: var(--cp-border-hover);
      box-shadow: var(--cp-glow);
      transform: translateY(-2px);
    }
    .action-btn svg {
      width: 28px;
      height: 28px;
      color: var(--cp-accent);
    }
    .action-btn.primary {
      background: linear-gradient(135deg, var(--cp-accent), #0099cc);
      color: #fff;
      border: none;
    }
    .action-btn.primary svg { color: #fff; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 16px;
      padding: 16px;
    }

    .stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--cp-text-muted);
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--cp-accent);
      margin: 4px 0;
    }
    .stat-value.good { color: var(--cp-green); }
    .stat-value.warn { color: var(--cp-amber); }
    .stat-value.fail { color: var(--cp-red); }

    .stat-hint {
      font-size: 0.7rem;
      color: var(--cp-text-muted);
    }

    /* Collapsible Sections */
    .section {
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 20px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .section-header:hover {
      background: var(--cp-accent-bg);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 700;
      color: var(--cp-text);
    }
    .section-title svg {
      width: 20px;
      height: 20px;
      color: var(--cp-accent);
    }

    .section-meta {
      font-size: 0.75rem;
      color: var(--cp-text-muted);
    }

    .section-toggle {
      width: 24px;
      height: 24px;
      color: var(--cp-text-muted);
      transition: transform 0.3s;
    }
    .section.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-body {
      padding: 0 20px 20px;
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .section.collapsed .section-body {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    /* Filters */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }

    .filter-input, .filter-select {
      flex: 1;
      min-width: 120px;
      height: 40px;
      padding: 8px 12px;
      background: var(--cp-input-bg);
      border: 1px solid var(--cp-border);
      border-radius: 10px;
      color: var(--cp-text);
      font-size: 0.85rem;
    }
    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--cp-accent);
    }

    .date-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .date-label {
      font-size: 0.7rem;
      color: var(--cp-text-muted);
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
      border-radius: 12px;
      max-height: 400px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .data-table thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--cp-bg);
      color: var(--cp-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid var(--cp-border);
    }

    .data-table td {
      padding: 10px;
      border-bottom: 1px solid var(--cp-border);
      vertical-align: top;
      color: var(--cp-text-secondary);
    }

    .data-table tbody tr:hover td {
      background: rgba(0, 212, 255, 0.03);
    }

    .data-table a {
      color: var(--cp-accent);
      text-decoration: none;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    /* Status badges */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.pass { background: var(--cp-green-bg); color: var(--cp-green); }
    .badge.fail { background: var(--cp-red-bg); color: var(--cp-red); }
    .badge.open { background: var(--cp-amber-bg); color: var(--cp-amber); }
    .badge.complete { background: var(--cp-accent-bg); color: var(--cp-accent); }

    /* Download buttons */
    .download-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--cp-surface);
      border: 1px solid var(--cp-border);
      border-radius: 8px;
      color: var(--cp-text);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover {
      border-color: var(--cp-border-hover);
    }
    .btn svg { width: 14px; height: 14px; }
    .btn.green { background: var(--cp-green-bg); border-color: var(--cp-green); color: var(--cp-green); }
    .btn.primary { background: linear-gradient(135deg, var(--cp-accent), #0099cc); color: #fff; border: none; }

    /* Floating user badge */
    .floating-user {
      position: fixed;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: var(--cp-surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--cp-border);
      border-radius: 50px;
      z-index: 100;
    }
    .floating-user-info { text-align: right; }
    .floating-user-name { font-size: 0.8rem; font-weight: 600; color: var(--cp-text); }
    .floating-user-role { font-size: 0.65rem; color: var(--cp-accent); text-transform: uppercase; letter-spacing: 0.05em; }
    .floating-user button {
      background: none;
      border: none;
      color: var(--cp-text-muted);
      cursor: pointer;
      padding: 5px;
      display: flex;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .floating-user button:hover { background: var(--cp-red-bg); color: var(--cp-red); }
    .floating-user svg { width: 16px; height: 16px; }

    /* Mobile Card View */
    @media (max-width: 720px) {
      .table-wrap { max-height: none !important; overflow: visible !important; }
      .data-table thead { display: none !important; }
      .data-table, .data-table tbody, .data-table tr, .data-table td {
        display: block !important;
        width: 100% !important;
      }
      .data-table tbody tr {
        margin: 10px 0 !important;
        padding: 14px !important;
        border-radius: 14px !important;
        border: 1px solid var(--cp-border) !important;
        background: var(--cp-card) !important;
      }
      .data-table tbody td {
        border: 0 !important;
        padding: 6px 0 !important;
        border-bottom: 1px solid var(--cp-border) !important;
      }
      .data-table tbody td:last-child { border-bottom: 0 !important; }
      .data-table tbody td::before {
        display: block;
        margin-bottom: 3px;
        font-size: 0.6rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--cp-text-muted);
        font-weight: 600;
      }
      #doorsBody td:nth-child(1)::before { content: "Door ID"; }
      #doorsBody td:nth-child(2)::before { content: "Status"; }
      #doorsBody td:nth-child(3)::before { content: "Last Inspection"; }
      #doorsBody td:nth-child(4)::before { content: "AAADM"; }
      #doorsBody td:nth-child(5)::before { content: "Location"; }
      #doorsBody td:nth-child(6)::before { content: "Notes"; }
      #tasksBody td:nth-child(1)::before { content: "Task ID"; }
      #tasksBody td:nth-child(2)::before { content: "Date"; }
      #tasksBody td:nth-child(3)::before { content: "Task"; }
      #tasksBody td:nth-child(4)::before { content: "Technician"; }
      #tasksBody td:nth-child(5)::before { content: "Status"; }
      #tasksBody td:nth-child(6)::before { content: "Summary"; }
      #tasksBody td:nth-child(7)::before { content: "Actions"; }
      #openTasksBody td:nth-child(1)::before { content: "Task ID"; }
      #openTasksBody td:nth-child(2)::before { content: "Door"; }
      #openTasksBody td:nth-child(3)::before { content: "Task"; }
      #openTasksBody td:nth-child(4)::before { content: "Status"; }
      #openTasksBody td:nth-child(5)::before { content: "Created"; }
      #openTasksBody td:nth-child(6)::before { content: "Actions"; }
      .filters { flex-direction: column; }
      .date-group { flex-wrap: wrap; }
      .floating-user-name, .floating-user-role { display: none; }
      /* Allow horizontal scroll on tables */
      .portal { overflow-x: auto; }
      .section-body { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .data-table { min-width: 600px; }
      /* Load More button stays visible */
      .load-more-row { position: sticky; left: 0; }
      .load-more-row td { text-align: center; padding: 16px; min-width: auto !important; }
    }

    @media (min-width: 768px) {
      .portal { padding: 24px; }
      .stats-grid { grid-template-columns: repeat(4, 1fr); }
      .quick-actions { grid-template-columns: repeat(4, 1fr); }
      .header { padding-top: 0; }
    }

    /* Desktop: hide jump nav, expand sections */
    @media (min-width: 900px) {
      .jump-nav { display: none; }
    }

    /* Open Tasks Status */
    .badge.in-progress { background: var(--cp-accent-bg); color: var(--cp-accent); }
    .badge.return { background: var(--cp-amber-bg); color: var(--cp-amber); }

    /* Small button */
    .btn.small {
      padding: 6px 10px;
      font-size: 0.75rem;
    }

    /* Unread badge */
    .unread-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--cp-red);
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 9px;
      margin-left: 6px;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--cp-surface);
      border: 1px solid var(--cp-border);
      border-radius: 20px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--cp-border);
    }
    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--cp-text);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--cp-text-muted);
      cursor: pointer;
      padding: 4px;
    }
    .modal-close:hover {
      color: var(--cp-red);
    }

    /* Message Thread */
    .message-thread {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--cp-card);
      border-radius: 12px;
    }
    .message-item {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
    }
    .message-item.customer {
      background: var(--cp-accent-bg);
      margin-left: 20px;
    }
    .message-item.admin {
      background: var(--cp-green-bg);
      margin-right: 20px;
    }
    .message-meta {
      font-size: 0.75rem;
      color: var(--cp-text-muted);
      margin-bottom: 4px;
    }
    .message-text {
      font-size: 0.9rem;
      color: var(--cp-text);
    }
    .message-input-wrap {
      display: flex;
      gap: 8px;
    }
    .message-input {
      flex: 1;
      padding: 12px;
      background: var(--cp-input-bg);
      border: 1px solid var(--cp-border);
      border-radius: 10px;
      color: var(--cp-text);
      font-size: 0.9rem;
      resize: none;
      font-family: inherit;
    }
    .message-input:focus {
      outline: none;
      border-color: var(--cp-accent);
    }

    /* PO Form */
    .po-form {
      display: grid;
      gap: 12px;
    }
    .po-form label {
      font-size: 0.85rem;
      color: var(--cp-text-secondary);
    }
    .po-form input {
      width: 100%;
      padding: 10px 12px;
      background: var(--cp-input-bg);
      border: 1px solid var(--cp-border);
      border-radius: 8px;
      color: var(--cp-text);
      font-size: 0.9rem;
    }
    .po-form input:focus {
      outline: none;
      border-color: var(--cp-accent);
    }

    /* Actions column */
    .actions-cell {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    /* Copilot FAB */
    .copilot-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cp-accent), #0099cc);
      border: none;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .copilot-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0, 212, 255, 0.6);
    }
    .copilot-fab svg { width: 28px; height: 28px; }

    .copilot-panel {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 380px;
      max-width: calc(100vw - 48px);
      max-height: 500px;
      background: var(--cp-surface);
      border: 1px solid var(--cp-border);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .copilot-panel.active { display: flex; }

    .copilot-header {
      padding: 16px;
      border-bottom: 1px solid var(--cp-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .copilot-title {
      font-weight: 700;
      color: var(--cp-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .copilot-close {
      background: none;
      border: none;
      color: var(--cp-text-muted);
      cursor: pointer;
    }
    .copilot-close:hover { color: var(--cp-red); }

    .copilot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .copilot-msg {
      padding: 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .copilot-msg.user {
      background: var(--cp-accent-bg);
      margin-left: 40px;
    }
    .copilot-msg.assistant {
      background: var(--cp-card);
      margin-right: 40px;
    }

    .copilot-input-area {
      padding: 12px;
      border-top: 1px solid var(--cp-border);
      display: flex;
      gap: 8px;
    }
    .copilot-input {
      flex: 1;
      padding: 10px 14px;
      background: var(--cp-input-bg);
      border: 1px solid var(--cp-border);
      border-radius: 10px;
      color: var(--cp-text);
      font-size: 0.9rem;
      font-family: inherit;
    }
    .copilot-input:focus {
      outline: none;
      border-color: var(--cp-accent);
    }
    .copilot-send {
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--cp-accent), #0099cc);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .copilot-suggestions {
      padding: 8px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .copilot-suggestion {
      padding: 5px 10px;
      background: var(--cp-card);
      border: 1px solid var(--cp-border);
      border-radius: 16px;
      color: var(--cp-text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
    }
    .copilot-suggestion:hover {
      background: var(--cp-accent-bg);
      border-color: var(--cp-accent);
      color: var(--cp-accent);
    }

    /* Mobile Table Fix */
    @media (max-width: 768px) {
      table { display: table !important; }
      thead { display: table-header-group !important; }
      tbody { display: table-row-group !important; }
      tr { display: table-row !important; height: auto !important; }
      td, th {
        display: table-cell !important;
        width: auto !important;
        padding: 8px !important;
        font-size: 12px !important;
      }
      .card {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      td::before { display: none !important; }
    }

    /* Load More Button */
    .load-more-row td {
      border-top: 1px solid var(--cp-border);
    }
    .load-more-row .btn {
      background: var(--cp-accent-bg);
      border: 1px solid var(--cp-accent);
      color: var(--cp-accent);
      padding: 10px 24px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .load-more-row .btn:hover {
      background: var(--cp-accent);
      color: white;
    }

    /* ===== MOBILE SCROLL FIX ===== */
    @media (max-width: 768px) {
      /* Allow horizontal scroll on tables */
      section {
        overflow: visible !important;
      }

      /* Allow vertical scroll - remove height constraints */
      .section-body {
        max-height: none;
        height: auto;
      }
    }

    /* Keep collapse working - needs to override mobile styles */
    .collapsed .section-body {
      max-height: 0 !important;
      overflow: hidden !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* Compliance Assistant Loading */
    .searching-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--cp-text-muted);
      font-style: italic;
    }
    .searching-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--cp-border);
      border-top-color: var(--cp-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Floor Map */
    .floor-tabs {
      display: flex;
      gap: 4px;
    }

    .floor-tab {
      padding: 6px 12px;
      font-size: 0.8rem;
      border: 1px solid var(--cp-border);
      background: var(--cp-card);
      color: var(--cp-text-secondary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .floor-tab:hover {
      border-color: var(--cp-accent);
    }

    .floor-tab.active {
      background: var(--cp-accent);
      color: white;
      border-color: var(--cp-accent);
    }

    .floor-map-container {
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f5;
      margin-top: 12px;
    }

    .map-note {
      font-size: 0.8rem;
      color: var(--cp-text-muted);
      margin-top: 8px;
    }

    /* Help Button */
    .help-btn {
      position: fixed;
      bottom: 24px;
      left: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--cp-card);
      border: 1px solid var(--cp-border);
      color: var(--cp-text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      transition: all 0.2s;
      z-index: 100;
    }
    .help-btn:hover {
      background: var(--cp-accent-bg);
      border-color: var(--cp-accent);
      color: var(--cp-accent);
    }

    .help-modal {
      max-width: 600px;
    }
    .help-content h4 {
      color: var(--cp-accent);
      margin: 20px 0 10px 0;
      font-size: 1rem;
    }
    .help-content h4:first-child {
      margin-top: 0;
    }
    .help-content p, .help-content li {
      color: var(--cp-text-secondary);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .help-content ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    .help-content a {
      color: var(--cp-accent);
    }
  </style>
</head>
<body>
  <div class="bg-effects"></div>

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <img src="https://images.squarespace-cdn.com/content/53292562e4b06710691770b4/c75debc4-7194-4008-875d-856c6fa3b205/dis+lis+logo.webp?content-type=image%2Fwebp" alt="AAS">
      <div class="auth-spinner"></div>
      <p id="authLoadingText" style="color: var(--cp-text-muted);">Loading...</p>
      <h1 class="auth-title">Sign In Required</h1>
      <p class="auth-subtitle">Please sign in to access your portal</p>
      <button id="authLoginBtn" class="auth-btn">Sign In</button>
    </div>
  </div>

  <div id="pageContent" class="page-content">
    <div class="portal">
      <!-- Jump Navigation (mobile) -->
      <nav class="jump-nav">
        <button class="jump-btn active" data-section="stats">Overview</button>
        <button class="jump-btn" data-section="floorMap">üó∫Ô∏è Map</button>
        <button class="jump-btn" data-section="doors">Doors</button>
        <button class="jump-btn" data-section="openTasks">Open Tasks</button>
        <button class="jump-btn" data-section="tasks">Service</button>
        <button class="jump-btn" data-section="actions">Actions</button>
      </nav>

      <!-- Header -->
      <header class="header" id="stats">
        <div class="header-info">
          <h1>Ochsner Westbank</h1>
          <p class="subtitle" id="userGreeting">Welcome back</p>
          <div class="customer-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Ochsner Medical Center - Westbank
          </div>
        </div>
      </header>

      <!-- Stats -->
      <section class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Openings</div>
          <div class="stat-value" id="statDoors">--</div>
          <div class="stat-hint" id="statDoorsHint">-- door leaves</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Compliance</div>
          <div class="stat-value good" id="statCompliance">--</div>
          <div class="stat-hint">NFPA 80</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Passing</div>
          <div class="stat-value good" id="statPass">--</div>
          <div class="stat-hint">Compliant</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Failing</div>
          <div class="stat-value fail" id="statFail">--</div>
          <div class="stat-hint">Needs attention</div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="quick-actions" id="actions">
        <a href="https://app.limblecmms.com/problem/wtwsbc13448/50187/16" target="_blank" rel="noopener" class="action-btn primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Request Service
        </a>
        <a href="sms:+15048105285?body=Ochsner%20Westbank%20Service%20Request:%20" class="action-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Text AAS
        </a>
        <a href="tel:+15043364422" class="action-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          Call AAS
        </a>
        <button class="action-btn" id="downloadReportBtn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          PDF Report
        </button>
      </section>

      <!-- Floor Map Section -->
      <section class="section" id="floorMap">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              üó∫Ô∏è Life Safety Floor Map
            </h2>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <!-- Map Toolbar -->
          <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
            <a href="https://drive.google.com/file/d/12Eqhejz9j7Syn7rcVkPiBffRxZDy_3Wl/view" target="_blank"
               class="btn" style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;font-size:0.85rem;">
              üîç Open Full Screen
            </a>
            <a href="https://drive.google.com/uc?export=download&id=12Eqhejz9j7Syn7rcVkPiBffRxZDy_3Wl"
               class="btn" style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;font-size:0.85rem;background:var(--cp-card);border:1px solid var(--cp-border);color:var(--cp-text);">
              ‚¨áÔ∏è Download PDF
            </a>
          </div>
          <!-- Simple Map Viewer -->
          <div style="border-radius:8px;overflow:hidden;background:#f5f5f5;">
            <iframe src="https://drive.google.com/file/d/12Eqhejz9j7Syn7rcVkPiBffRxZDy_3Wl/preview"
                    width="100%" height="500px" style="border:none;" allow="autoplay"></iframe>
          </div>
          <p style="font-size:0.8rem;color:var(--cp-text-muted);margin-top:8px;">
            Door IDs correspond to the Door Registry below. Life Safety drawings by HCT LLC.
          </p>
        </div>
      </section>

      <!-- Doors Section -->
      <section class="section" id="doors">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Door Inspections
            </h2>
            <p class="section-meta" id="doorsMeta">Loading...</p>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <div class="filters">
            <input id="doorSearch" class="filter-input" type="text" placeholder="Search doors..." />
            <select id="doorStatusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="PASS">PASS</option>
              <option value="FAIL">FAIL</option>
            </select>
          </div>
          <div class="download-group" style="margin-bottom: 12px;">
            <button id="downloadDoorsCSV" class="btn green">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              CSV
            </button>
            <button id="downloadDoorsPDF" class="btn primary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              PDF
            </button>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Door ID</th>
                  <th>Status</th>
                  <th>Last Inspection</th>
                  <th>AAADM</th>
                  <th>Location</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="doorsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Open Tasks Section -->
      <section class="section" id="openTasks">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Open Tasks
            </h2>
            <p class="section-meta" id="openTasksMeta">Loading...</p>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <div class="filters">
            <input id="openTaskSearch" class="filter-input" type="text" placeholder="Search open tasks..." />
            <select id="openTaskStatusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="Open">Open</option>
              <option value="In Progress">In Progress</option>
              <option value="Return for Parts">Return for Parts</option>
            </select>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Task ID</th>
                  <th>Door</th>
                  <th>Task</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="openTasksBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Tasks Section -->
      <section class="section" id="tasks">
        <div class="section-header" onclick="toggleSection(this.parentElement)">
          <div>
            <h2 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
              </svg>
              Service Activity
            </h2>
            <p class="section-meta" id="tasksMeta">Loading...</p>
          </div>
          <svg class="section-toggle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="section-body">
          <div class="filters">
            <input id="taskSearch" class="filter-input" type="text" placeholder="Search tasks..." />
            <select id="taskStatusFilter" class="filter-select">
              <option value="">All Status</option>
              <option value="COMPLETE">COMPLETE</option>
              <option value="OPEN">OPEN</option>
            </select>
            <div class="date-group">
              <span class="date-label">From</span>
              <input id="fromInput" class="filter-input" type="date" style="min-width: 130px;" />
              <span class="date-label">To</span>
              <input id="toInput" class="filter-input" type="date" style="min-width: 130px;" />
            </div>
          </div>
          <div class="download-group" style="margin-bottom: 12px;">
            <button id="downloadTasksCSV" class="btn green">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              CSV
            </button>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Task ID</th>
                  <th>Date</th>
                  <th>Task</th>
                  <th>Technician</th>
                  <th>Status</th>
                  <th>Summary</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tasksBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="floatingUser" class="floating-user" style="display: none;">
    <div class="floating-user-info">
      <div id="floatingUserName" class="floating-user-name">User</div>
      <div id="floatingUserRole" class="floating-user-role">Customer</div>
    </div>
    <button onclick="window.AASAuth?.logout()" title="Sign Out">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
    </button>
  </div>

  <!-- Message Modal -->
  <div id="messageModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Task #<span id="modalTaskId"></span></h3>
        <button class="modal-close" onclick="closeMessageModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="messageThread" class="message-thread">
        <p style="color: var(--cp-text-muted); text-align: center;">No messages yet</p>
      </div>
      <div class="message-input-wrap">
        <textarea id="messageInput" class="message-input" rows="2" placeholder="Type your message..."></textarea>
        <button class="btn primary" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- PO Modal -->
  <div id="poModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Submit PO - Task #<span id="poModalTaskId"></span></h3>
        <button class="modal-close" onclick="closePoModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form class="po-form" onsubmit="submitPO(event)">
        <div>
          <label for="customerWO">Customer Work Order #</label>
          <input type="text" id="customerWO" placeholder="Optional">
        </div>
        <div>
          <label for="customerPO">Customer PO #</label>
          <input type="text" id="customerPO" placeholder="Required" required>
        </div>
        <div>
          <label for="approvedBy">Approved By</label>
          <input type="text" id="approvedBy" placeholder="Your name" required>
        </div>
        <button type="submit" class="btn primary" style="width:100%;justify-content:center;">
          Submit PO Information
        </button>
      </form>
    </div>
  </div>

  <!-- Help Button -->
  <button class="help-btn" onclick="openHelpModal()" title="How to use this portal">?</button>

  <!-- Help Modal -->
  <div id="helpModal" class="modal-overlay">
    <div class="modal-content help-modal">
      <div class="modal-header">
        <h3 class="modal-title">Portal Help</h3>
        <button class="modal-close" onclick="closeHelpModal()">‚úï</button>
      </div>
      <div class="help-content">
        <h4>üìä Dashboard Overview</h4>
        <p>The dashboard shows your door compliance status and recent service activity. Use the date filters to view specific time periods.</p>

        <h4>üö™ Door Registry</h4>
        <p>View all automatic doors at your facility. Click any door ID to see detailed inspection history.</p>
        <ul>
          <li><strong>PASS</strong> - Door meets all NFPA 80 requirements</li>
          <li><strong>FAIL</strong> - Door needs service to meet compliance</li>
        </ul>

        <h4>üìã Service Tasks</h4>
        <p>Track all open and completed service work on your doors:</p>
        <ul>
          <li><strong>Open</strong> - Work scheduled but not started</li>
          <li><strong>In Progress</strong> - Technician actively working</li>
          <li><strong>Return for Parts</strong> - Waiting on parts to complete</li>
          <li><strong>Complete</strong> - Work finished</li>
        </ul>
        <p>Action buttons:</p>
        <ul>
          <li><strong>üí¨ Message</strong> - Send a note to AAS about this task</li>
          <li><strong>üìÑ Submit PO</strong> - Provide your PO number for billing</li>
        </ul>

        <h4>ü§ñ Compliance Assistant</h4>
        <p>Click the blue chat button (bottom right) to get help understanding:</p>
        <ul>
          <li>Your compliance percentage and what it means</li>
          <li>NFPA 80 fire door requirements</li>
          <li>What inspection findings mean</li>
          <li>Fire door compliance questions</li>
        </ul>

        <h4>üìû Contact AAS</h4>
        <p>
          Phone: <a href="tel:+15043364422">(504) 336-4422</a><br>
          Text: <a href="sms:+15048105285">(504) 810-5285</a><br>
          Email: <a href="mailto:service@automaticaccesssolution.com">service@automaticaccesssolution.com</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Copilot AI -->
  <button class="copilot-fab" onclick="toggleCopilot()" title="Ask Copilot">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
    </svg>
  </button>

  <div class="copilot-panel" id="copilotPanel">
    <div class="copilot-header">
      <div class="copilot-title">
        üõ°Ô∏è Compliance Assistant
      </div>
      <div style="display:flex;gap:8px;">
        <button class="copilot-close" onclick="resetCopilot()" title="Reset conversation">‚Ü∫</button>
        <button class="copilot-close" onclick="toggleCopilot()" title="Close">‚úï</button>
      </div>
    </div>

    <div class="copilot-messages" id="copilotMessages">
      <div class="copilot-msg assistant">
        Hi! I'm your Compliance Assistant. I can help you understand:<br>
        ‚Ä¢ Your fire door inspection results<br>
        ‚Ä¢ NFPA 80 compliance requirements<br>
        ‚Ä¢ What inspection findings mean<br><br>
        What compliance questions do you have?
      </div>
    </div>

    <div class="copilot-suggestions" id="copilotSuggestions"></div>

    <div class="copilot-input-area">
      <input type="text" class="copilot-input" id="copilotInput" placeholder="Ask about your doors or compliance..." onkeypress="if(event.key==='Enter')sendCopilotMessage()">
      <button class="copilot-send" onclick="sendCopilotMessage()">Send</button>
    </div>
  </div>

  <script>
    // Ochsner Westbank Customer Portal
    const CUSTOMER_KEY = 'ochsner_westbank';
    const CUSTOMER_LABEL = 'Ochsner Medical Center - Westbank';
    const DOOR_PREFIX = 'WB-';
    const TASKS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=1853712655&single=true&output=csv';
    const INSPECTIONS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=2106704799&single=true&output=csv';
    const OPEN_TASKS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=1087890358&single=true&output=csv';
    const TASK_NOTES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaL-Cagmos7f4rCojgOROSm_Zs8Gnl41nvUUN8hXJIrDyGdv4eYhtJKq56lMRK9euN0TvFNOj_rszM/pub?gid=797841380&single=true&output=csv';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxieMXC3yxR1TeJVbYPhzLpgS-IVtVd_JOfERJP76p1ZT6vzFVb4Wo2KjcHIe0_5O4WPg/exec';

    // Pagination - show 50 items, then "Load More"
    let taskDisplayCount = 50;
    let doorDisplayCount = 50;

    // Status priority for deduplication (higher = more current)
    const STATUS_PRIORITY = {
      'OPEN': 1,
      'IN_PROGRESS': 2,
      'PARTS_NEEDED': 3,
      'RETURN_FOR_PARTS': 3,
      'COMPLETE': 4
    };

    function $(id) { return document.getElementById(id); }
    function clean(v) { return (v == null ? '' : String(v)).trim(); }
    function escapeHtml(s) { return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function stripHtml(s) { return String(s || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim(); }

    function parseCSV(text) {
      const rows = []; let row = [], cell = '', inQ = false;
      const s = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (inQ) {
          if (ch === '"') { if (s[i+1] === '"') { cell += '"'; i++; } else { inQ = false; } }
          else { cell += ch; }
        } else {
          if (ch === '"') { inQ = true; }
          else if (ch === ',') { row.push(cell); cell = ''; }
          else if (ch === '\n') { row.push(cell); if (row.some(v => v.trim())) rows.push(row); row = []; cell = ''; }
          else { cell += ch; }
        }
      }
      if (cell.length || row.length) { row.push(cell); if (row.some(v => v.trim())) rows.push(row); }
      return rows;
    }

    async function loadCSV(url) {
      if (!url) return { rows: [], hdr: [], col: () => '' };
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`CSV fetch failed: ${resp.status}`);
      const text = await resp.text();
      const rows = parseCSV(text);
      if (!rows.length) throw new Error('Empty CSV');
      const hdr = rows[0].map(h => clean(h));
      const ix = Object.fromEntries(hdr.map((h, i) => [h.toLowerCase(), i]));
      const col = (r, name) => {
        const i = ix[name.toLowerCase()];
        return i === undefined ? '' : clean(r[i] || '');
      };
      return { rows: rows.slice(1), hdr, col };
    }

    function parseDate(s) {
      const str = String(s || '').trim();
      let m = str.match(/^(\d{1,2})\/(\d{4})$/);
      if (m) return { month: +m[1], year: +m[2], day: 1, sortKey: +m[2] * 10000 + +m[1] * 100, display: str };
      m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        let year = +m[3]; if (year < 100) year += 2000;
        return { month: +m[1], year, day: +m[2], sortKey: year * 10000 + +m[1] * 100 + +m[2], display: str };
      }
      return null;
    }

    function parseDateInput(s) {
      if (!s) return null;
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      return { year: +m[1], month: +m[2], day: +m[3], sortKey: +m[1] * 10000 + +m[2] * 100 + +m[3] };
    }

    function baseStatus(s) {
      const up = String(s || '').trim().toUpperCase();
      if (up.includes('PASS')) return 'PASS';
      if (up.includes('FAIL')) return 'FAIL';
      if (up.includes('COMPLETE')) return 'COMPLETE';
      if (up.includes('OPEN')) return 'OPEN';
      return up;
    }

    function statusClass(s) {
      const st = baseStatus(s);
      if (st === 'PASS') return 'pass';
      if (st === 'FAIL') return 'fail';
      if (st === 'OPEN') return 'open';
      if (st === 'COMPLETE') return 'complete';
      return '';
    }

    function downloadCSV(filename, rows) {
      const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const csv = rows.map(r => r.map(esc).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function generateCompliancePDF(title, customer, summary, headers, data, compliancePct, filename) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      doc.setFontSize(20);
      doc.setTextColor(0, 80, 120);
      doc.text(title, 14, 18);

      doc.setFontSize(14);
      doc.setTextColor(60);
      doc.text(customer, 14, 28);

      const badgeColor = compliancePct >= 90 ? [34, 197, 94] : compliancePct >= 70 ? [245, 158, 11] : [239, 68, 68];
      doc.setFillColor(...badgeColor);
      doc.roundedRect(220, 12, 60, 20, 3, 3, 'F');
      doc.setFontSize(16);
      doc.setTextColor(255);
      doc.text(`${compliancePct}% Compliant`, 225, 25);

      doc.setFillColor(245, 247, 250);
      doc.rect(14, 34, 268, 50, 'F');
      doc.setDrawColor(200);
      doc.rect(14, 34, 268, 50, 'S');

      doc.setFontSize(9);
      doc.setTextColor(50);
      let yPos = 42;
      summary.forEach((line) => {
        if (line.startsWith('REGULATORY') || line.startsWith('‚Ä¢')) {
          doc.setFont(undefined, line.startsWith('REGULATORY') ? 'bold' : 'normal');
        }
        doc.text(line, 18, yPos);
        yPos += 5;
      });
      doc.setFont(undefined, 'normal');

      doc.autoTable({
        startY: 90,
        head: [headers],
        body: data,
        theme: 'striped',
        headStyles: { fillColor: [0, 100, 140], textColor: 255, fontStyle: 'bold', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3 },
        alternateRowStyles: { fillColor: [248, 250, 252] },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 20 },
          2: { cellWidth: 25 },
          3: { cellWidth: 20 },
          4: { cellWidth: 50 },
          5: { cellWidth: 'auto' }
        }
      });

      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(120);
        doc.text(`Automatic Access Solutions ‚Ä¢ Fire Door Inspection Report ‚Ä¢ Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 220, doc.internal.pageSize.height - 10);
      }

      doc.save(filename);
    }

    // Collapsible sections
    function toggleSection(section) {
      section.classList.toggle('collapsed');
    }

    // Floor map - Google Drive URL for mobile
    const FLOOR_MAP_DRIVE_URL = 'https://drive.google.com/file/d/12Eqhejz9j7Syn7rcVkPiBffRxZDy_3Wl/view';

    let floorMapCollapsed = false;

    function toggleFloorMap() {
      floorMapCollapsed = !floorMapCollapsed;
      const content = $('floorMapContent');
      const toggle = $('floorMapToggle');
      const note = $('floorMapNote');
      const tabs = $('floorTabs');

      if (floorMapCollapsed) {
        content.style.display = 'none';
        note.style.display = 'none';
        if (tabs) tabs.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      } else {
        content.style.display = 'block';
        note.style.display = 'block';
        if (tabs) tabs.style.display = 'flex';
        toggle.textContent = '‚ñº';
      }
    }

    function showFloor(floorNum, event) {
      console.log('[Portal] showFloor called:', floorNum);

      if (event) {
        event.preventDefault();
        event.stopPropagation();
        document.querySelectorAll('.floor-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
      }

      // PDF pages: cover=1, floor1=2, floor2=3, floor3=4, floor4=5
      const pageNum = floorNum + 1;
      const frame = document.getElementById('floorMapFrame');
      console.log('[Portal] Frame found:', !!frame, 'Setting page:', pageNum);

      if (frame) {
        frame.src = '/westbank/maps/life-safety-map.pdf#page=' + pageNum;
      }
    }

    function initFloorMap() {
      const container = $('floorMapContent');
      if (!container) return;

      const isMobile = window.innerWidth < 768;

      if (isMobile) {
        container.innerHTML = `
          <div style="text-align:center;padding:24px;background:var(--cp-card);border-radius:8px;border:1px solid var(--cp-border);">
            <p style="margin-bottom:16px;color:var(--cp-text-secondary);">
              View the complete Life Safety floor plans:
            </p>
            <a href="${FLOOR_MAP_DRIVE_URL}" target="_blank" class="btn"
               style="display:inline-flex;align-items:center;gap:8px;padding:12px 24px;text-decoration:none;">
              üìÑ Open Floor Map
            </a>
            <p style="margin-top:12px;font-size:0.8rem;color:var(--cp-text-muted);">
              Opens in Google Drive viewer
            </p>
          </div>
        `;
        if ($('floorTabs')) $('floorTabs').style.display = 'none';
      } else {
        container.innerHTML = `
          <div class="floor-map-container" style="border-radius:8px;overflow:hidden;background:#f5f5f5;">
            <iframe id="floorMapFrame" src="/westbank/maps/life-safety-map.pdf#page=2"
                    width="100%" height="500px" style="border:none;"></iframe>
          </div>
        `;
        if ($('floorTabs')) $('floorTabs').style.display = 'flex';
      }
    }

    // Handle resize (desktop <-> mobile)
    let floorMapResizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(floorMapResizeTimeout);
      floorMapResizeTimeout = setTimeout(initFloorMap, 250);
    });

    // ============================================
    // PAGINATION FUNCTIONS
    // ============================================

    function loadMoreTasks() {
      taskDisplayCount += 50;
      render();
    }

    function loadMoreDoors() {
      doorDisplayCount += 50;
      render();
    }

    function resetPagination() {
      taskDisplayCount = 50;
      doorDisplayCount = 50;
    }

    // Jump navigation
    function setupJumpNav() {
      const buttons = document.querySelectorAll('.jump-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const sectionId = btn.dataset.section;
          const section = document.getElementById(sectionId);
          if (section) {
            // Remove collapsed state
            if (section.classList.contains('collapsed')) {
              section.classList.remove('collapsed');
            }
            // Scroll into view
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Update active state
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          }
        });
      });

      // Intersection observer for active state
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            buttons.forEach(b => {
              b.classList.toggle('active', b.dataset.section === id);
            });
          }
        });
      }, { threshold: 0.3 });

      ['stats', 'doors', 'openTasks', 'tasks', 'actions'].forEach(id => {
        const el = document.getElementById(id);
        if (el) observer.observe(el);
      });
    }

    // App state
    let tasks = [], doors = [];
    let openTasks = [];
    let taskNotes = [];
    let currentUser = null;
    let currentModalTaskId = null;

    async function loadData() {
      $('doorsMeta').textContent = 'Loading doors...';
      $('tasksMeta').textContent = 'Loading tasks...';

      let taskCSV = { rows: [], col: () => '' };
      let doorCSV;

      try {
        doorCSV = await loadCSV(INSPECTIONS_CSV);
      } catch (e) {
        console.error('[Portal] Door CSV error:', e);
        $('doorsMeta').textContent = 'Error loading door data';
        return;
      }

      try {
        taskCSV = await loadCSV(TASKS_CSV);
      } catch (e) {
        console.error('[Portal] Task CSV error:', e);
        $('tasksMeta').textContent = 'Error loading tasks';
      }

      // Parse tasks
      tasks = taskCSV.rows.map(r => ({
        taskId: taskCSV.col(r, 'Task ID'),
        dateStr: taskCSV.col(r, 'Service Date'),
        dateObj: parseDate(taskCSV.col(r, 'Service Date')),
        tech: taskCSV.col(r, 'Technician'),
        status: baseStatus(taskCSV.col(r, 'Status & type')),
        summary: stripHtml(taskCSV.col(r, 'Summary')),
        taskName: taskCSV.col(r, 'Task Name') || taskCSV.col(r, 'Location Name'),
        woLink: taskCSV.col(r, 'WO Link')
      })).filter(t => t.taskId || t.dateStr || t.summary);

      console.log('[Portal] Loaded', tasks.length, 'tasks');

      // Parse doors - filter by prefix
      doors = doorCSV.rows.map(r => ({
        doorId: doorCSV.col(r, 'Door ID'),
        aaadm: doorCSV.col(r, 'AAADM'),
        qrLink: doorCSV.col(r, 'QR Link'),
        lastInspection: doorCSV.col(r, 'Last Inspection'),
        dateObj: parseDate(doorCSV.col(r, 'Last Inspection')),
        status: baseStatus(doorCSV.col(r, 'Status')),
        tech: doorCSV.col(r, 'Technician'),
        notes: doorCSV.col(r, 'Notes'),
        retested: doorCSV.col(r, 'Retested'),
        location: doorCSV.col(r, 'Location')
      })).filter(d => d.doorId && d.doorId.startsWith(DOOR_PREFIX));

      console.log('[Portal] Loaded', doors.length, 'doors for', DOOR_PREFIX);

      // Load open tasks
      try {
        const openTasksData = await loadCSV(OPEN_TASKS_CSV);
        openTasks = openTasksData.rows
          .filter(r => openTasksData.col(r, 'Customer') === 'Westbank')
          .map(r => ({
            taskId: openTasksData.col(r, 'Task_ID'),
            assetId: openTasksData.col(r, 'Asset_ID'),
            doorName: openTasksData.col(r, 'Door_Name'),
            taskName: openTasksData.col(r, 'Task_Name'),
            status: openTasksData.col(r, 'Status'),
            createdDate: openTasksData.col(r, 'Created_Date'),
            notes: openTasksData.col(r, 'Notes'),
            link: openTasksData.col(r, 'Link')
          }))
          .filter(t => t.taskId);
        console.log('[Portal] Open tasks loaded:', openTasks.length);

        // Deduplicate: Keep only latest status per Task_ID
        const latestByTaskId = new Map();
        openTasks.forEach(t => {
          const existing = latestByTaskId.get(t.taskId);
          if (!existing) {
            latestByTaskId.set(t.taskId, t);
          } else {
            const existingDate = new Date(existing.createdDate || 0);
            const newDate = new Date(t.createdDate || 0);
            const existingStatus = existing.status?.toUpperCase().replace(/ /g, '_') || '';
            const newStatus = t.status?.toUpperCase().replace(/ /g, '_') || '';
            const existingPriority = STATUS_PRIORITY[existingStatus] || 0;
            const newPriority = STATUS_PRIORITY[newStatus] || 0;
            if (newDate > existingDate || (newDate.getTime() === existingDate.getTime() && newPriority > existingPriority)) {
              latestByTaskId.set(t.taskId, t);
            }
          }
        });
        openTasks = Array.from(latestByTaskId.values());
        console.log('[Portal] Open tasks after dedup:', openTasks.length);

        // Transform and merge open tasks into main tasks array
        const openTasksMerged = openTasks.map(t => {
          let summary = t.notes || t.taskName || '';
          if (!summary || summary.length < 10) {
            summary = t.doorName ? `Service: ${t.doorName}` : 'Scheduled service';
          }
          return {
            taskId: t.taskId,
            dateStr: t.createdDate,
            dateObj: parseDate(t.createdDate),
            tech: t.tech || '',
            status: t.status?.toUpperCase().replace(/ /g, '_') || 'OPEN',
            summary: summary,
            taskName: t.taskName,
            doorName: t.doorName,
            woLink: t.link,
            isOpen: true
          };
        });

        // Merge open tasks, avoiding duplicates
        const existingTaskIds = new Set(tasks.map(t => t.taskId));
        const uniqueOpenTasks = openTasksMerged.filter(t => !existingTaskIds.has(t.taskId));
        tasks = [...uniqueOpenTasks, ...tasks];
        console.log('[Portal] Merged open tasks. Added:', uniqueOpenTasks.length, 'Total:', tasks.length);
      } catch (e) {
        console.warn('[Portal] Open tasks not available:', e);
        openTasks = [];
      }

      // Load task notes for messaging
      try {
        const notesData = await loadCSV(TASK_NOTES_CSV);
        taskNotes = notesData.rows
          .filter(r => notesData.col(r, 'Customer') === 'Westbank')
          .map(r => ({
            timestamp: notesData.col(r, 'Timestamp'),
            taskId: notesData.col(r, 'Task_ID'),
            fromEmail: notesData.col(r, 'From_Email'),
            fromName: notesData.col(r, 'From_Name'),
            role: notesData.col(r, 'Role'),
            message: notesData.col(r, 'Message'),
            read: notesData.col(r, 'Read')
          }));
        console.log('[Portal] Task notes loaded:', taskNotes.length);
      } catch (e) {
        console.warn('[Portal] Task notes not available:', e);
        taskNotes = [];
      }

      // Debug: Log task breakdown
      console.log('[Portal] Task breakdown:', {
        total: tasks.length,
        open: tasks.filter(t => t.isOpen).length,
        openStatus: tasks.filter(t => baseStatus(t.status) === 'OPEN').length,
        inProgress: tasks.filter(t => baseStatus(t.status) === 'IN_PROGRESS').length,
        returnForParts: tasks.filter(t => baseStatus(t.status) === 'RETURN_FOR_PARTS').length,
        complete: tasks.filter(t => baseStatus(t.status) === 'COMPLETE').length
      });
    }

    function getFilters() {
      const doorQ = ($('doorSearch').value || '').toLowerCase().trim();
      const taskQ = ($('taskSearch').value || '').toLowerCase().trim();
      const doorStatus = ($('doorStatusFilter').value || '').toUpperCase();
      const taskStatus = ($('taskStatusFilter').value || '').toUpperCase();
      const from = parseDateInput($('fromInput').value);
      const to = parseDateInput($('toInput').value);
      return { doorQ, taskQ, doorStatus, taskStatus, from, to };
    }

    function inDateRange(dateObj, from, to) {
      if (!from && !to) return true;
      if (!dateObj) return false;
      if (from && dateObj.sortKey < from.sortKey) return false;
      if (to && dateObj.sortKey > to.sortKey) return false;
      return true;
    }

    function countDoors(doorsArr) {
      let openings = doorsArr.length;
      let doorLeaves = 0;
      doorsArr.forEach(door => {
        const name = door.doorId || '';
        if (name.includes('/')) {
          doorLeaves += 2;
        } else {
          doorLeaves += 1;
        }
      });
      return { openings, doorLeaves };
    }

    function getFilteredData() {
      const { doorQ, taskQ, doorStatus, taskStatus, from, to } = getFilters();

      const filteredDoors = doors.filter(d => {
        if (doorStatus && d.status !== doorStatus) return false;
        if (doorQ) {
          const blob = `${d.doorId} ${d.location} ${d.notes} ${d.tech}`.toLowerCase();
          if (!blob.includes(doorQ)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      const filteredTasks = tasks.filter(t => {
        if (taskStatus) {
          if (taskStatus === 'COMPLETE' && t.status !== 'COMPLETE') return false;
          if (taskStatus === 'OPEN' && t.status === 'COMPLETE') return false;
        }
        if (!inDateRange(t.dateObj, from, to)) return false;
        if (taskQ) {
          const blob = `${t.summary} ${t.tech} ${t.taskName}`.toLowerCase();
          if (!blob.includes(taskQ)) return false;
        }
        return true;
      }).sort((a, b) => (b.dateObj?.sortKey || 0) - (a.dateObj?.sortKey || 0));

      return { filteredDoors, filteredTasks };
    }

    function render() {
      const { filteredDoors, filteredTasks } = getFilteredData();

      const passCount = filteredDoors.filter(d => d.status === 'PASS').length;
      const failCount = filteredDoors.filter(d => d.status === 'FAIL').length;
      const totalWithStatus = passCount + failCount;
      const compliancePct = totalWithStatus > 0 ? Math.round((passCount / totalWithStatus) * 100) : 0;

      // Count openings vs door leaves
      const { openings, doorLeaves } = countDoors(filteredDoors);

      $('statDoors').textContent = openings;
      $('statDoorsHint').textContent = `${doorLeaves} door leaves`;
      $('statCompliance').textContent = compliancePct + '%';
      $('statCompliance').className = 'stat-value' + (compliancePct >= 90 ? ' good' : compliancePct >= 70 ? ' warn' : ' fail');
      $('statPass').textContent = passCount;
      $('statFail').textContent = failCount;
      $('statFail').className = 'stat-value' + (failCount > 0 ? ' fail' : ' good');

      // Doors table - with pagination
      const doorsBody = $('doorsBody');
      doorsBody.innerHTML = '';
      if (filteredDoors.length === 0) {
        doorsBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--cp-text-muted);padding:30px;">No doors match filters</td></tr>';
      } else {
        const visibleDoors = filteredDoors.slice(0, doorDisplayCount);
        const remainingDoors = filteredDoors.length - visibleDoors.length;

        visibleDoors.forEach(d => {
          const notes = d.retested ? `${d.notes} [${d.retested}]` : d.notes;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><a href="/door/?id=${encodeURIComponent(d.doorId)}">${escapeHtml(d.doorId)}</a></td>
            <td><span class="badge ${statusClass(d.status)}">${escapeHtml(d.status)}</span></td>
            <td>${escapeHtml(d.lastInspection)}</td>
            <td>${escapeHtml(d.aaadm)}</td>
            <td>${escapeHtml(d.location)}</td>
            <td>${escapeHtml(notes)}</td>
          `;
          doorsBody.appendChild(tr);
        });

        // Add Load More button if more doors exist
        if (remainingDoors > 0) {
          const loadMoreRow = document.createElement('tr');
          loadMoreRow.className = 'load-more-row';
          loadMoreRow.innerHTML = `
            <td colspan="6" style="text-align:center;padding:16px;">
              <button class="btn" onclick="loadMoreDoors()" style="min-width:200px;">
                Load More (${remainingDoors} remaining)
              </button>
            </td>
          `;
          doorsBody.appendChild(loadMoreRow);
        }
      }
      $('doorsMeta').textContent = `Showing ${Math.min(doorDisplayCount, filteredDoors.length)} of ${openings} Openings (${doorLeaves} Doors) ‚Ä¢ ${passCount} passing, ${failCount} failing`;

      // Update jump nav doors button
      const doorsJumpBtn = document.querySelector('.jump-btn[data-section="doors"]');
      if (doorsJumpBtn) doorsJumpBtn.textContent = `üö™ ${openings} Openings (${doorLeaves} Doors)`;

      // Tasks table - with pagination
      const tasksBody = $('tasksBody');
      tasksBody.innerHTML = '';
      if (filteredTasks.length === 0) {
        tasksBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--cp-text-muted);padding:30px;">No tasks match filters</td></tr>';
      } else {
        const visibleTasks = filteredTasks.slice(0, taskDisplayCount);
        const remainingTasks = filteredTasks.length - visibleTasks.length;

        visibleTasks.forEach(t => {
          const unreadCount = taskNotes.filter(n => n.taskId === t.taskId && n.role === 'admin' && n.read !== 'Y').length;
          const unreadBadge = unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : '';
          const isComplete = baseStatus(t.status) === 'COMPLETE';

          const tr = document.createElement('tr');
          const taskIdLink = t.woLink ? `<a href="${escapeHtml(t.woLink)}" target="_blank">${escapeHtml(t.taskId)}</a>` : escapeHtml(t.taskId);

          tr.innerHTML = `
            <td>${taskIdLink}${unreadBadge}</td>
            <td>${escapeHtml(t.dateStr)}</td>
            <td>${escapeHtml(t.taskName || '-')}</td>
            <td>${escapeHtml(t.tech)}</td>
            <td><span class="badge ${statusClass(t.status)}">${escapeHtml(t.status)}</span></td>
            <td>${escapeHtml(t.summary)}</td>
            <td class="actions-cell">
              <button class="btn small" onclick="openMessageModal('${escapeHtml(t.taskId)}')" title="Send message to AAS about this task">üí¨</button>
              ${isComplete ? `<button class="btn small green" onclick="openPoModal('${escapeHtml(t.taskId)}')" title="Submit your PO or Work Order number">üìÑ</button>` : ''}
            </td>
          `;
          tasksBody.appendChild(tr);
        });

        // Add Load More button if more tasks exist
        if (remainingTasks > 0) {
          const loadMoreRow = document.createElement('tr');
          loadMoreRow.className = 'load-more-row';
          loadMoreRow.innerHTML = `
            <td colspan="7" style="text-align:center;padding:16px;">
              <button class="btn" onclick="loadMoreTasks()" style="min-width:200px;">
                Load More (${remainingTasks} remaining)
              </button>
            </td>
          `;
          tasksBody.appendChild(loadMoreRow);
        }
      }
      $('tasksMeta').textContent = `Showing ${Math.min(taskDisplayCount, filteredTasks.length)} of ${filteredTasks.length} service records`;

      // Open Tasks table
      const openTasksBody = $('openTasksBody');
      if (openTasksBody) {
        const openQ = ($('openTaskSearch')?.value || '').toLowerCase();
        const openStatusFilter = $('openTaskStatusFilter')?.value || '';

        const filteredOpenTasks = openTasks.filter(t => {
          if (openStatusFilter && t.status !== openStatusFilter) return false;
          if (openQ && !`${t.taskId} ${t.doorName} ${t.taskName} ${t.notes}`.toLowerCase().includes(openQ)) return false;
          return true;
        });

        openTasksBody.innerHTML = '';
        if (filteredOpenTasks.length === 0) {
          openTasksBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--cp-text-muted);padding:30px;">No open tasks</td></tr>';
        } else {
          filteredOpenTasks.forEach(t => {
            const unreadCount = taskNotes.filter(n => n.taskId === t.taskId && n.role === 'admin' && n.read !== 'Y').length;
            const unreadBadge = unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : '';

            let statusClass = 'open';
            if (t.status === 'In Progress') statusClass = 'in-progress';
            if (t.status === 'Return for Parts') statusClass = 'return';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <a href="${escapeHtml(t.link)}" target="_blank">${escapeHtml(t.taskId)}</a>
                ${unreadBadge}
              </td>
              <td>${escapeHtml(t.doorName)}</td>
              <td>${escapeHtml(t.taskName)}</td>
              <td><span class="badge ${statusClass}">${escapeHtml(t.status)}</span></td>
              <td>${escapeHtml(t.createdDate)}</td>
              <td>
                <button class="btn small" onclick="openMessageModal('${escapeHtml(t.taskId)}')">üí¨</button>
              </td>
            `;
            openTasksBody.appendChild(tr);
          });
        }
        $('openTasksMeta').textContent = `${filteredOpenTasks.length} open tasks`;

        // Update jump nav button
        const openTasksJumpBtn = document.querySelector('.jump-btn[data-section="openTasks"]');
        if (openTasksJumpBtn) openTasksJumpBtn.textContent = `‚è≥ ${filteredOpenTasks.length} Open`;
      }

      // Update copilot suggestions with real data
      updateCopilotSuggestions();
    }

    function getDateRangeStr() {
      const from = $('fromInput').value;
      const to = $('toInput').value;
      if (from && to) return `${from}-to-${to}`;
      if (from) return `from-${from}`;
      if (to) return `to-${to}`;
      return new Date().toISOString().slice(0, 10);
    }

    function setupDownloads() {
      $('downloadDoorsCSV').onclick = () => {
        const { filteredDoors } = getFilteredData();
        const rows = [['Door ID', 'Status', 'Last Inspection', 'AAADM', 'Location', 'Notes', 'Retested']];
        filteredDoors.forEach(d => {
          rows.push([d.doorId, d.status, d.lastInspection, d.aaadm, d.location, d.notes, d.retested]);
        });
        downloadCSV(`ochsner-westbank-doors-${getDateRangeStr()}.csv`, rows);
      };

      $('downloadDoorsPDF').onclick = generateFullReport;
      $('downloadReportBtn').onclick = generateFullReport;

      $('downloadTasksCSV').onclick = () => {
        const { filteredTasks } = getFilteredData();
        const rows = [['Task ID', 'Service Date', 'Task Name', 'Technician', 'Status', 'Work Performed']];
        filteredTasks.forEach(t => {
          rows.push([t.taskId, t.dateStr, t.taskName, t.tech, t.status, t.summary]);
        });
        downloadCSV(`ochsner-westbank-service-${getDateRangeStr()}.csv`, rows);
      };
    }

    function generateFullReport() {
      const { filteredDoors } = getFilteredData();
      const passCount = filteredDoors.filter(d => d.status === 'PASS').length;
      const failCount = filteredDoors.filter(d => d.status === 'FAIL').length;
      const totalWithStatus = passCount + failCount;
      const compliancePct = totalWithStatus > 0 ? Math.round((passCount / totalWithStatus) * 100) : 0;

      const { openings, doorLeaves } = countDoors(filteredDoors);
      const summary = [
        `Customer: ${CUSTOMER_LABEL}`,
        `Openings: ${openings} (${doorLeaves} Door Leaves)  |  Passing: ${passCount}  |  Failing: ${failCount}  |  Compliance: ${compliancePct}%`,
        `Report Date: ${new Date().toLocaleDateString()}`,
        ``,
        `REGULATORY STANDARDS:`,
        `‚Ä¢ NFPA 80: Standard for Fire Doors and Other Opening Protectives`,
        `  Requires annual inspection of all fire door assemblies.`,
        `‚Ä¢ Joint Commission EC.02.03.05 EP-25:`,
        `  Fire door assemblies must be inspected and tested annually per NFPA 80.`
      ];

      const headers = ['Door ID', 'Status', 'Last Insp', 'AAADM', 'Location', 'Notes'];
      const data = filteredDoors.map(d => [
        d.doorId, d.status, d.lastInspection, d.aaadm,
        d.location, d.retested ? `${d.notes} [${d.retested}]` : d.notes
      ]);

      generateCompliancePDF(
        'Fire Door Inspection Report',
        CUSTOMER_LABEL,
        summary, headers, data,
        compliancePct,
        `ochsner-westbank-inspection-report-${getDateRangeStr()}.pdf`
      );
    }

    async function initPage(user, roles, customerId) {
      currentUser = user;
      console.log('[Portal] Init for', user?.email, 'customer:', customerId);

      // Update greeting
      $('userGreeting').textContent = `Welcome, ${user?.name || user?.email || 'Customer'}`;

      // Default date range: last 90 days
      const now = new Date();
      const fromDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      $('fromInput').value = fromDate.toISOString().slice(0, 10);
      $('toInput').value = now.toISOString().slice(0, 10);

      // Bind filters
      $('doorSearch').addEventListener('input', render);
      $('taskSearch').addEventListener('input', render);
      $('doorStatusFilter').addEventListener('change', render);
      $('taskStatusFilter').addEventListener('change', render);
      $('fromInput').addEventListener('change', render);
      $('toInput').addEventListener('change', render);
      $('openTaskSearch')?.addEventListener('input', render);
      $('openTaskStatusFilter')?.addEventListener('change', render);

      setupDownloads();
      setupJumpNav();

      try {
        await loadData();
        render();
      } catch (e) {
        console.error('[Portal] Load error:', e);
        $('doorsMeta').textContent = 'Error loading data';
        $('tasksMeta').textContent = 'Error loading data';
      }
    }

    // ===== HELP MODAL FUNCTIONS =====

    function openHelpModal() {
      $('helpModal').classList.add('active');
    }

    function closeHelpModal() {
      $('helpModal').classList.remove('active');
    }

    // ===== MESSAGING FUNCTIONS =====

    function openMessageModal(taskId) {
      currentModalTaskId = taskId;
      $('modalTaskId').textContent = taskId;

      const messages = taskNotes.filter(n => n.taskId === taskId);
      const thread = $('messageThread');

      if (messages.length === 0) {
        thread.innerHTML = '<p style="color: var(--cp-text-muted); text-align: center;">No messages yet. Start the conversation!</p>';
      } else {
        thread.innerHTML = messages.map(m => `
          <div class="message-item ${m.role}">
            <div class="message-meta">${escapeHtml(m.fromName)} ‚Ä¢ ${escapeHtml(m.timestamp)}</div>
            <div class="message-text">${escapeHtml(m.message)}</div>
          </div>
        `).join('');
        thread.scrollTop = thread.scrollHeight;
      }

      $('messageModal').classList.add('active');
      $('messageInput').focus();
    }

    function closeMessageModal() {
      $('messageModal').classList.remove('active');
      $('messageInput').value = '';
      currentModalTaskId = null;
    }

    async function sendMessage() {
      const message = $('messageInput').value.trim();
      if (!message || !currentModalTaskId) return;

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add_message',
            taskId: currentModalTaskId,
            customer: 'Westbank',
            fromEmail: currentUser?.email || 'unknown',
            fromName: currentUser?.name || currentUser?.email || 'Customer',
            role: 'customer',
            message: message
          })
        });

        // Add to local array for immediate display
        const now = new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' });
        taskNotes.push({
          timestamp: now,
          taskId: currentModalTaskId,
          fromEmail: currentUser?.email || 'unknown',
          fromName: currentUser?.name || 'Customer',
          role: 'customer',
          message: message,
          read: 'N'
        });

        openMessageModal(currentModalTaskId);
        $('messageInput').value = '';

      } catch (e) {
        console.error('[Portal] Send message error:', e);
        alert('Message sent! (Confirmation pending)');
        closeMessageModal();
      }

      btn.disabled = false;
      btn.textContent = 'Send';
    }

    // ===== PO SUBMISSION FUNCTIONS =====

    function openPoModal(taskId) {
      $('poModalTaskId').textContent = taskId;
      currentModalTaskId = taskId;
      $('customerWO').value = '';
      $('customerPO').value = '';
      $('approvedBy').value = currentUser?.name || '';
      $('poModal').classList.add('active');
    }

    function closePoModal() {
      $('poModal').classList.remove('active');
      currentModalTaskId = null;
    }

    async function submitPO(e) {
      e.preventDefault();

      const customerWO = $('customerWO').value.trim();
      const customerPO = $('customerPO').value.trim();
      const approvedBy = $('approvedBy').value.trim();

      if (!customerPO || !approvedBy) {
        alert('Please fill in PO # and Approved By');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'submit_po',
            taskId: currentModalTaskId,
            customer: 'Westbank',
            customerWO: customerWO,
            customerPO: customerPO,
            approvedBy: approvedBy
          })
        });

        alert('PO information submitted successfully!');
        closePoModal();

      } catch (e) {
        console.error('[Portal] Submit PO error:', e);
        alert('PO submitted! (Confirmation pending)');
        closePoModal();
      }

      btn.disabled = false;
      btn.textContent = 'Submit PO Information';
    }

    // ===== MODAL EVENT LISTENERS =====

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMessageModal();
        closePoModal();
        closeHelpModal();
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.id === 'messageModal') closeMessageModal();
      if (e.target.id === 'poModal') closePoModal();
      if (e.target.id === 'helpModal') closeHelpModal();
    });

    // ===== COPILOT FUNCTIONS =====

    function toggleCopilot() {
      $('copilotPanel').classList.toggle('active');
      if ($('copilotPanel').classList.contains('active')) {
        $('copilotInput').focus();
      }
    }

    function resetCopilot() {
      const messages = $('copilotMessages');
      messages.innerHTML = `
        <div class="copilot-msg assistant">
          Hi! I'm your Compliance Assistant. I can help you understand:<br>
          ‚Ä¢ Your fire door inspection results<br>
          ‚Ä¢ NFPA 80 compliance requirements<br>
          ‚Ä¢ What inspection findings mean<br><br>
          What compliance questions do you have?
        </div>
      `;
      $('copilotSuggestions').style.display = 'flex';
      updateCopilotSuggestions();
      $('copilotInput').value = '';
    }

    function updateCopilotSuggestions() {
      const failCount = doors.filter(d => baseStatus(d.status) === 'FAIL').length;
      const passCount = doors.filter(d => baseStatus(d.status) === 'PASS').length;
      const totalInspected = failCount + passCount;
      const compliancePct = totalInspected > 0 ? Math.round((passCount / totalInspected) * 100) : 0;

      let suggestions = [];

      // Compliance percentage
      suggestions.push({
        text: `My compliance: ${compliancePct}%`,
        query: `What does my ${compliancePct}% compliance rate mean? What should I know about maintaining fire door compliance?`
      });

      // NFPA 80 help - always show
      suggestions.push({
        text: 'NFPA 80 requirements',
        query: 'What are the key NFPA 80 fire door inspection requirements I should understand for my facility?'
      });

      // Failing doors if any - compliance focused
      if (failCount > 0) {
        suggestions.push({
          text: `${failCount} doors need attention`,
          query: `${failCount} of my doors are not in compliance. What inspection issues were found and what do they mean?`
        });
      }

      // Inspection questions
      suggestions.push({
        text: 'Inspection requirements',
        query: 'How often do fire doors need to be inspected and what does an inspection involve?'
      });

      // Limit to 4 max
      suggestions = suggestions.slice(0, 4);

      $('copilotSuggestions').innerHTML = suggestions.map(s =>
        `<button class="copilot-suggestion" onclick="askCopilot('${s.query.replace(/'/g, "\\'")}')">${s.text}</button>`
      ).join('');
    }

    // Show loading state when searching
    function showSearchingState() {
      const msgContainer = document.getElementById('copilotMessages');
      if (!msgContainer) return;

      removeSearchingState(); // Remove any existing

      const searchingDiv = document.createElement('div');
      searchingDiv.className = 'copilot-msg assistant';
      searchingDiv.id = 'searchingMsg';
      searchingDiv.innerHTML = `
        <div class="searching-indicator">
          <div class="searching-spinner"></div>
          <span>Searching NFPA codes for accurate compliance information...</span>
        </div>
      `;
      msgContainer.appendChild(searchingDiv);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    function removeSearchingState() {
      const existing = document.getElementById('searchingMsg');
      if (existing) existing.remove();
    }

    function addCopilotMessage(content, role) {
      removeSearchingState(); // Remove searching indicator when adding real message
      const messages = $('copilotMessages');
      const msg = document.createElement('div');
      msg.className = `copilot-msg ${role}`;
      msg.innerHTML = content.replace(/\n/g, '<br>');
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    function askCopilot(question) {
      $('copilotInput').value = question;
      sendCopilotMessage();
    }

    async function sendCopilotMessage() {
      const input = $('copilotInput');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addCopilotMessage(message, 'user');
      $('copilotSuggestions').style.display = 'none';

      // Show searching indicator
      showSearchingState();

      try {
        let authToken = null;
        try {
          const client = await window.AASAuth?.initAuth();
          if (client) {
            authToken = await client.getTokenSilently();
          }
        } catch (e) {
          console.warn('[Copilot] Could not get auth token:', e);
        }

        const { filteredDoors } = getFilteredData();
        const passCount = filteredDoors.filter(d => d.status === 'PASS').length;
        const failCount = filteredDoors.filter(d => d.status === 'FAIL').length;
        const compliancePct = filteredDoors.length > 0 ? Math.round((passCount / filteredDoors.length) * 100) : 0;

        // Build rich context for copilot
        const openTasksList = tasks.filter(t => t.isOpen);
        const failingDoors = filteredDoors.filter(d => d.status === 'FAIL');

        // Format task details
        const openTaskDetails = openTasksList.length > 0
          ? openTasksList.map(t =>
              `  - Task ${t.taskId}: ${t.taskName || 'Service'} at ${t.doorName || 'Unknown door'} - Status: ${t.status}${t.summary ? ' - Notes: ' + t.summary : ''}`
            ).join('\n')
          : '  None';

        // Format failing door details
        const failingDoorDetails = failingDoors.length > 0
          ? failingDoors.slice(0, 10).map(d =>
              `  - ${d.doorId}: ${d.location || 'Location not specified'} - Issue: ${d.notes || 'See inspection report'}`
            ).join('\n')
          : '  None';

        // Build context string
        const contextPrefix = `
CUSTOMER PORTAL DATA:
- Facility: ${CUSTOMER_LABEL}
- Total doors monitored: ${filteredDoors.length}
- Doors passing inspection: ${passCount}
- Doors failing inspection: ${failCount}
- Current compliance rate: ${compliancePct}%

OPEN SERVICE TASKS (${openTasksList.length} total):
${openTaskDetails}

DOORS CURRENTLY FAILING (${failCount} total):
${failingDoorDetails}

---
CUSTOMER QUESTION: `;

        const messageWithContext = contextPrefix + message;

        const headers = { 'Content-Type': 'application/json' };
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const response = await fetch('/api/copilot', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            messages: [{ role: 'user', content: messageWithContext }],
            mode: 'customer_portal',
            customer: CUSTOMER_KEY,
            customerContext: {
              customer: CUSTOMER_KEY,
              customerLabel: CUSTOMER_LABEL,
              userEmail: currentUser?.email || 'unknown',
              totalDoors: filteredDoors.length,
              passingDoors: passCount,
              failingDoors: failCount,
              compliancePercent: compliancePct,
              openTasks: openTasksList.length
            }
          })
        });

        removeSearchingState();

        if (response.status === 401) {
          addCopilotMessage('Your session may have expired. Please refresh the page or sign out and back in.', 'assistant');
          return;
        }

        if (response.status === 403) {
          addCopilotMessage('You don\'t have access to this feature.', 'assistant');
          return;
        }

        if (!response.ok) throw new Error('API error');

        const data = await response.json();
        addCopilotMessage(data.response || 'Sorry, I could not process that.', 'assistant');

      } catch (e) {
        console.error('[Copilot] Error:', e);
        removeSearchingState();
        addCopilotMessage('Sorry, I\'m having trouble connecting. Please try again.', 'assistant');
      }
    }

    window.onPageReady = initPage;
  </script>
  <script src="/auth.js"></script>
  <script src="/theme.js" defer></script>
  <script src="/copilot.js" defer></script>
</body>
</html>
