<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline Ops &bull; AAS Portal</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0a0a0f; color: #fff; min-height: 100vh; }
    .auth-overlay { position: fixed; inset: 0; background: rgba(10,10,15,0.98); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-overlay.hidden { display: none; }
    .auth-card { text-align: center; padding: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; max-width: 400px; }
    .auth-title { font-size: 28px; font-weight: 700; margin: 0 0 8px; background: linear-gradient(135deg, #00d4ff, #6ea8fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: none; }
    .auth-subtitle { color: rgba(255,255,255,0.7); margin: 0 0 24px; display: none; }
    .auth-btn { display: none; background: linear-gradient(135deg, #00d4ff, #0099cc); color: #0a0a0f; border: none; padding: 14px 32px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
    .auth-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .page-content { display: none; }

    .shell { max-width: 980px; margin: 0 auto; padding: 88px 20px 40px; }
    .header h1 { margin: 0; font-size: 30px; }
    .header p { margin: 8px 0 0; color: rgba(255,255,255,.7); }
    .grid { margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 18px; box-shadow: 0 8px 28px rgba(0,0,0,.25); }
    .card h2 { font-size: 18px; margin: 0 0 10px; }
    .muted { color: rgba(255,255,255,.66); font-size: 14px; }
    .status-pill { display: inline-flex; align-items: center; gap: 8px; padding: 7px 11px; border-radius: 999px; border: 1px solid rgba(255,255,255,.22); background: rgba(255,255,255,.08); margin-top: 12px; font-size: 13px; font-weight: 600; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
    .status-connected .status-dot { background: #10b981; }
    .status-expired .status-dot { background: #f59e0b; }
    .status-disconnected .status-dot { background: #ef4444; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
    button { border: 1px solid rgba(0,212,255,.36); color: #c9f4ff; background: rgba(0,212,255,.12); border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
    button.secondary { border-color: rgba(255,255,255,.25); color: rgba(255,255,255,.86); background: rgba(255,255,255,.08); }
    .link-card { display: flex; flex-direction: column; gap: 10px; text-decoration: none; color: inherit; }
    .link-card:hover { border-color: rgba(0,212,255,.4); box-shadow: 0 12px 30px rgba(0,212,255,.12); transform: translateY(-1px); }
    .link-title { font-size: 16px; font-weight: 700; }
    .link-meta { font-size: 13px; color: rgba(255,255,255,.6); }
    .count-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); font-size: 12px; font-weight: 600; }
    .count-warn { color: #f59e0b; border-color: rgba(245,158,11,.4); background: rgba(245,158,11,.08); }
    .count-bad { color: #ef4444; border-color: rgba(239,68,68,.4); background: rgba(239,68,68,.08); }
    .count-good { color: #10b981; border-color: rgba(16,185,129,.4); background: rgba(16,185,129,.08); }
    .count-info { color: #00d4ff; border-color: rgba(0,212,255,.4); background: rgba(0,212,255,.08); }
  </style>
</head>
<body>
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <div class="auth-spinner"></div>
      <p id="authLoadingText">Loading...</p>
      <h1 class="auth-title">Sign In Required</h1>
      <p class="auth-subtitle">Please sign in to access Pipeline Ops</p>
      <button id="authLoginBtn" class="auth-btn">Sign In</button>
    </div>
  </div>

  <button class="nav-toggle" id="navToggle" onclick="toggleNav()">
    <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
    <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
  </button>

  <div class="nav-panel__overlay" id="navOverlay" onclick="toggleNav()"></div>

  <nav class="nav-panel" id="navPanel">
    <a href="/" class="nav-panel__link" data-admin-only><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>Dashboard</a>
    <div class="nav-panel__section">Tools</div>
    <a href="/tech/command/" class="nav-panel__link" data-admin-only><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Command Center</a>
    <a href="/tech/parts/" class="nav-panel__link"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Parts Finder</a>
    <a href="/tech/manuals/" class="nav-panel__link"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>Tech Manuals</a>
    <a href="/tech/doors/" class="nav-panel__link"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21h18M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16" /></svg>Door Browser</a>
    <a href="/tech/summary/" class="nav-panel__link" data-admin-only><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>Work Summary</a>
    <a href="/pipeline/" class="nav-panel__link" data-admin-only><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" /></svg>Invoice Pipeline</a>
    <div class="nav-panel__divider"></div>
    <a href="https://app.limblecmms.com" target="_blank" rel="noopener" class="nav-panel__link"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>Open Limble</a>
  </nav>

  <div class="floating-user" id="floatingUser" style="display:none;">
    <div class="floating-user__info">
      <div class="floating-user__name" id="floatingUserName">User</div>
      <div class="floating-user__role" id="floatingUserRole">-</div>
    </div>
    <button class="floating-user__logout" onclick="window.AASAuth?.logout()" title="Sign Out">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
    </button>
  </div>

  <div id="pageContent" class="page-content">
    <div class="shell">
      <header class="header">
        <h1>Pipeline Ops</h1>
        <p>Admin launchpad for invoice pipeline reviews and live status.</p>
      </header>

      <section class="grid">
        <article class="card">
          <h2>Pipeline Status</h2>
          <p class="muted">Live counts from pipeline API.</p>
          <div class="actions" id="statsRow">
            <span class="count-pill count-warn" id="statCustomers">Customers: —</span>
            <span class="count-pill count-bad" id="statParts">Parts: —</span>
            <span class="count-pill count-info" id="statRates">Tiers: —</span>
            <span class="count-pill" id="statBilling">Billing: —</span>
          </div>
        </article>

        <article class="card">
          <h2>QuickBooks Connection</h2>
          <p class="muted">OAuth status check.</p>
          <div id="qbStatus" class="status-pill status-disconnected">
            <span class="status-dot"></span>
            <span>Checking...</span>
          </div>
          <div class="actions">
            <button id="connectBtn" type="button">Connect QuickBooks</button>
            <button id="refreshBtn" class="secondary" type="button">Refresh Status</button>
          </div>
        </article>
      </section>

      <section class="grid">
        <a class="card link-card" href="/pipeline/customers/">
          <div class="link-title">Customer Map Review</div>
          <div class="link-meta">Verify Limble ↔ QB customer matches</div>
          <div class="count-pill count-warn" id="linkCustomers">Needs review: —</div>
        </a>
        <a class="card link-card" href="/pipeline/parts/">
          <div class="link-title">Part Map Review</div>
          <div class="link-meta">Resolve unmapped parts and pricing</div>
          <div class="count-pill count-bad" id="linkParts">Unmapped: —</div>
        </a>
        <a class="card link-card" href="/pipeline/rates/">
          <div class="link-title">Rate Cards</div>
          <div class="link-meta">Manage labor and travel tiers</div>
          <div class="count-pill count-info" id="linkRates">Active tiers: —</div>
        </a>
        <a class="card link-card" href="/pipeline/log/">
          <div class="link-title">Billing Log</div>
          <div class="link-meta">Invoice history and errors</div>
          <div class="count-pill" id="linkBilling">Total: —</div>
        </a>
        <a class="card link-card" href="/pipeline/">
          <div class="link-title">Pipeline Dashboard</div>
          <div class="link-meta">Live stats and queue overview</div>
          <div class="count-pill" id="linkDashboard">Open: —</div>
        </a>
        <a class="card link-card" href="/pipeline/preview/">
          <div class="link-title">Invoice Preview</div>
          <div class="link-meta">Phase 2 — dry run &amp; process</div>
          <div class="count-pill">Coming soon</div>
        </a>
      </section>
    </div>
  </div>

<script>
  function toggleNav() {
    document.getElementById('navToggle').classList.toggle('active');
    document.getElementById('navPanel').classList.toggle('open');
    document.getElementById('navOverlay').classList.toggle('open');
  }
  document.addEventListener('DOMContentLoaded', function() {
    var path = window.location.pathname;
    document.querySelectorAll('.nav-panel__link').forEach(function(link) {
      var href = link.getAttribute('href');
      if (!href) return;
      if (href === path || (href !== '/' && path.startsWith(href))) link.classList.add('active');
    });
  });
</script>

<script>
  async function fetchQbStatus() {
    const statusEl = document.getElementById('qbStatus');
    try {
      const token = window.AASAuth ? await window.AASAuth.getToken() : null;
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const response = await fetch('/api/qb/status', { method: 'GET', headers });
      const payload = await response.json();
      const state = (payload.status || 'disconnected').toLowerCase();
      const cls = state === 'connected' ? 'status-connected' : state === 'expired' ? 'status-expired' : 'status-disconnected';
      statusEl.className = `status-pill ${cls}`;
      statusEl.innerHTML = `<span class="status-dot"></span><span>${state}</span>`;
    } catch {
      statusEl.className = 'status-pill status-disconnected';
      statusEl.innerHTML = '<span class="status-dot"></span><span>Unavailable</span>';
    }
  }

  async function fetchPipelineStats() {
    const token = window.AASAuth ? await window.AASAuth.getToken() : null;
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
    const response = await fetch('/api/pipeline/stats', { method: 'GET', headers });
    if (!response.ok) throw new Error('Pipeline stats unavailable');
    const stats = await response.json();
    const customerNeeds = stats?.customer_map?.NEEDS_REVIEW ?? 0;
    const partsUnmapped = stats?.part_map?.UNMAPPED ?? 0;
    const tiers = stats?.rate_card?.active_tiers ?? 0;
    const billingTotal = stats?.billing_log?.total ?? 0;

    document.getElementById('statCustomers').textContent = `Customers: ${customerNeeds}`;
    document.getElementById('statParts').textContent = `Parts: ${partsUnmapped}`;
    document.getElementById('statRates').textContent = `Tiers: ${tiers}`;
    document.getElementById('statBilling').textContent = `Billing: ${billingTotal}`;

    document.getElementById('linkCustomers').textContent = `Needs review: ${customerNeeds}`;
    document.getElementById('linkParts').textContent = `Unmapped: ${partsUnmapped}`;
    document.getElementById('linkRates').textContent = `Active tiers: ${tiers}`;
    document.getElementById('linkBilling').textContent = `Total: ${billingTotal}`;
    document.getElementById('linkDashboard').textContent = `Open: ${customerNeeds + partsUnmapped}`;
  }

  document.getElementById('connectBtn')?.addEventListener('click', async () => {
    try {
      const token = window.AASAuth ? await window.AASAuth.getToken() : null;
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const response = await fetch('/api/qb/connect', { method: 'GET', headers });
      const payload = await response.json();
      if (payload?.url) { window.location.href = payload.url; return; }
      alert('Unable to start OAuth flow.');
    } catch { alert('Unable to reach QB connect endpoint.'); }
  });

  document.getElementById('refreshBtn')?.addEventListener('click', fetchQbStatus);

  window.onPageReady = async () => {
    try {
      await fetchPipelineStats();
    } catch (e) {
      console.error('[Pipeline Ops] Stats error:', e);
    }
    await fetchQbStatus();
  };
</script>

</body>
</html>
